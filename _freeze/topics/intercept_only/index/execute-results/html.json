{
  "hash": "f6364a9d80607be62c49f5c314e512a3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle:  Fitting an intercept-only model\ndescription: |\n  Where is the variation?\nexecute:\n  freeze: true\nformat:\n  html:\n    code-tools: true\neditor_options: \n  chunk_output_type: console\n---\n\n## Variance partitioning with hierarchical models\n\nIts very useful to have an idea of where the variation is in a dataset, as a guide to model building and future data collection. Before collecting information on independent variables that you think might explain variation -- first find out how much variation there is! \n\nRandom intercepts give us a very handy way to investigate this: the so-called \"intercept only\" model. \nAt this point in the course we now have all the tools needed to build it. There are two steps: first we build a model with no predictors at all, only a random intercept for every grouping variable in the data (e.g. species, sites, years, regions). Then we examine the relative magnitudes of the standard deviations to see which is relatively larger or smaller.\n\n## Abundance of mites in different samples\n\nWe're going to build this by extending the observation level random effect model from the previous section. Remember that observation-level random effects are mostly useful for Poisson distributions! If you want to extend this model to other kinds of data, remember to remove that part of it.\n\n### Mathematical model\n\n$$\n\\begin{align}\n\\text{Abundance}_i &\\sim \\text{Poisson}(\\lambda_i) \\\\\n\\log{\\lambda_i} &\\sim \\mu + \\beta_{\\text{sample}[i]} + \\beta_{\\text{species[i]}} + \\beta_i\\\\\n\\mu &\\sim \\text{Normal}(3, 1)\\\\\n\\beta_{\\text{sample}} &\\sim \\text{Normal}(0,  \\sigma_{\\text{samp}})\\\\\n\\beta_{\\text{species}} &\\sim \\text{Normal}(0, \\sigma_{\\text{species}})\\\\\n\\beta_i &\\sim \\text{Normal}(0,                \\sigma_{\\text{obs}}) \\\\\n\\sigma_{\\text{samp}}    &\\sim \\text{Exponential}(3)\\\\\n\\sigma_{\\text{species}} &\\sim \\text{Exponential}(3)\\\\\n\\sigma_{\\text{obs}}     &\\sim \\text{Exponential}(3)\n\\end{align}\n$$\n\n### Load packages and prepare data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages(library(dplyr))\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(tidybayes)\nlibrary(brms)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Rcpp\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading 'brms' package (version 2.23.0). Useful instructions\ncan be found by typing help('brms'). A more detailed introduction\nto the package is available through vignette('brms_overview').\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'brms'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:tidybayes':\n\n    dstudent_t, pstudent_t, qstudent_t, rstudent_t\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    ar\n```\n\n\n:::\n\n```{.r .cell-code}\ndata(\"mite\", package = \"vegan\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspp_names <- colnames(mite)\nspp_names <- setNames(1:ncol(mite), colnames(mite))\n\n\nmite_long <- mite |> \n  mutate(site_id = seq_len(nrow(mite))) |> \n  tidyr::pivot_longer(-site_id,\n                      names_to = \"spp\",\n                      values_to = \"abd\") |> \n  dplyr::mutate(spp_id = spp_names[spp])\n\nknitr::kable(head(mite_long))\n```\n\n::: {.cell-output-display}\n\n\n| site_id|spp     | abd| spp_id|\n|-------:|:-------|---:|------:|\n|       1|Brachy  |  17|      1|\n|       1|PHTH    |   5|      2|\n|       1|HPAV    |   5|      3|\n|       1|RARD    |   3|      4|\n|       1|SSTR    |   2|      5|\n|       1|Protopl |   1|      6|\n\n\n:::\n:::\n\n\n\n## EXERCISE \n\ncreate a Poisson model of species abundance that offers *three* random intercepts: one for species, one for site, and another for observation level. \nTIP: the dataset has no factor for observation-level variance, you will have to create one.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## data\nmite_long_siteid <- mite_long |> \n  mutate(obs_id = seq_along(spp))\n\n# formula\nmite_intercept_only_bf <- bf(abd ~ 1 + (1 | spp_id) + (1 | site_id) + (1 | obs_id), family = poisson(link = \"log\"))\n\nget_prior(mite_intercept_only_bf, data = mite_long_siteid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                   prior     class      coef   group resp dpar nlpar lb ub tag\n student_t(3, -2.3, 2.5) Intercept                                            \n    student_t(3, 0, 2.5)        sd                                    0       \n    student_t(3, 0, 2.5)        sd            obs_id                  0       \n    student_t(3, 0, 2.5)        sd Intercept  obs_id                  0       \n    student_t(3, 0, 2.5)        sd           site_id                  0       \n    student_t(3, 0, 2.5)        sd Intercept site_id                  0       \n    student_t(3, 0, 2.5)        sd            spp_id                  0       \n    student_t(3, 0, 2.5)        sd Intercept  spp_id                  0       \n       source\n      default\n      default\n (vectorized)\n (vectorized)\n (vectorized)\n (vectorized)\n (vectorized)\n (vectorized)\n```\n\n\n:::\n\n```{.r .cell-code}\nmite_intercept_only_prior <- c(\n  prior(normal(3, 1), class = \"Intercept\"),\n  prior(exponential(3), class = \"sd\")\n)\n\nmite_intercept_only_brm <- brm(\n  mite_intercept_only_bf,\n  data = mite_long_siteid,\n  prior = mite_intercept_only_prior,\n  sample_prior = \"yes\",\n  file = here::here(\"topics/intercept_only/mite_intercept_only_brm.rds\"),\n  cores = 4)\n```\n:::\n\n\nTo examine the relative magnitudes of the standard deviations\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(tidybayes::get_variables(mite_intercept_only_brm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"b_Intercept\"           \"sd_obs_id__Intercept\"  \"sd_site_id__Intercept\"\n[4] \"sd_spp_id__Intercept\"  \"Intercept\"             \"r_obs_id[1,Intercept]\"\n```\n\n\n:::\n\n```{.r .cell-code}\nbayesplot::mcmc_areas(mite_intercept_only_brm, \n                      regex_pars = \"sd_.*\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nWhat's the average abundance of each species? To answer this question, we can extract _only_ the random effects of species, and create a kind of rank-abundance plot. Note that we don't need to transform the response, because `tidybayes::add_epred_rvars` applies the link function for us:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmite_long_siteid |> \n  select(spp, spp_id) |> \n  distinct() |> \n  tidybayes::add_epred_rvars(\n    mite_intercept_only_brm, \n    re_formula = ~ (1 | spp_id)\n    ) |> \n  mutate(avg_abd=.epred,\n         spp = forcats::fct_reorder(.f = spp, .x = .epred)) |>\n  ggplot(aes(y = spp, xdist = .epred)) + \n  stat_dist_pointinterval()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nPosterior predictions look alright also:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npp_check(mite_intercept_only_brm) + coord_cartesian(xlim = c(0,100))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nUsing 10 posterior draws for ppc type 'dens_overlay' by default.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCoordinate system already present.\nâ„¹ Adding new coordinate system, which will replace the existing one.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n<!-- :::{.callout-warning} -->\n<!-- ## Warning: irresponsible statistics -->\n<!-- I'm sampling only 2 chains below, for illustration purposes only! use more chains in your research. -->\n<!-- ::: -->\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}