{
  "hash": "283d23dec7b708a2b4ba7bccceed5fd8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Gaussian Processes in Stan\"\ndescription: |\n  Smooth lines in fancy colours.\nexecute:\n  freeze: true\ncomments:\n  hypothesis: true\nformat:\n  html:\n    code-tools: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n:::{.callout-tip}\n## Goals of this lesson\n1. Let's appreciate together the power of online community resources\n1. Gaussian Processes are families of smooth functions we learn from data\n1. When used for prediction, a GP is both a \"prior\" and a \"likelihood\"\n:::\n\n## Background reading\n\nGaussian processes are very common, and there are lots of resources on the topic:\n\n1. The Stan manual [has a chapter on it](https://mc-stan.org/docs/stan-users-guide/gaussian-processes.html)\n1. The Stan team gives lots of [example models on Github](https://github.com/stan-dev/example-models/blob/master/misc/gaussian-process/gp-fit-logit.stan) which I adapted for this example.\n1. Michael Betancourt has an extremely detailed, very rigous [tutorial on GPs](https://betanalpha.github.io/assets/case_studies/gaussian_processes.html#3_Inferring_A_Gaussian_Process)\n1. Here's a complete, worked [analysis of human birthdays](https://avehtari.github.io/casestudies/Birthdays/birthdays.html#Model_4:_long_term_smooth_+_seasonal_+_weekday_with_increasing_magnitude) by world-class statisticians (Gelman, Vehtari, Simpson, et al)\n1. GPs are related to GAMs and can be represented by a collection of basis functions. This is approximate but much much faster. See this [excellent tutorial](https://avehtari.github.io/casestudies/Motorcycle/motorcycle_gpcourse.html#45_GP_with_basis_functions_for_f_and_g) by Aki Vehtari, and the corresponding paper (citation in the blog post).\n1. this [blog](https://rpubs.com/NickClark47/stan_geostatistical) applies GPs to spatial count data\n1. Here is a very long and wonderfully detailed post describing a GP approach to [occupany modelling](https://peter-stewart.github.io/blog/gaussian-process-occupancy-tutorial/)\n1. Another [blog on Gaussian Processes](https://brendanhasz.github.io/2018/10/10/hmm-vs-gp.html#generating-data-from-a-gaussian-process), Hidden Markov Models and more, very clear explanation.\n\n<!-- add equation -->\n\n<!-- add simulation -->\n\n### Reorganizing the mite data\n\nLet's begin by (once again!) loading and reorganizing the mite data. This time we'll also use `mite.xy`, which gives the coordinates of each one of the 70 samples.\n\n#### Loading models and data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages(library(dplyr))\nlibrary(ggplot2)\nlibrary(tidyr)\n# library(cmdstanr)\nsuppressPackageStartupMessages(library(brms))\nlibrary(tidybayes)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidybayes'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:brms':\n\n    dstudent_t, pstudent_t, qstudent_t, rstudent_t\n```\n\n\n:::\n\n```{.r .cell-code}\n# mite data\ndata(mite, package = \"vegan\")\ndata(mite.env, package = \"vegan\")\n\n## ALSO: the spatial data\ndata(mite.xy, package = \"vegan\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# combine data and environment\nmite_data_long <- bind_cols(mite.env, mite) |> \n  mutate(plot_id = 1:length(WatrCont)) |> \n  pivot_longer(Brachy:Trimalc2, names_to = \"spp\", values_to = \"abd\")\n\n\nmite_data_long_transformed <- mite_data_long |> \n  mutate(presabs = as.numeric(abd>0),\n         # center predictors\n         water = (WatrCont - mean(WatrCont)) / 100\n         )\n\n# pick a species that has about 50/50 chance \n\nmite_data_long_transformed |>\n  group_by(spp) |>\n  summarize(freq = mean(presabs)) |>\n  filter(freq > .4 & freq < .6)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n   spp       freq\n   <chr>    <dbl>\n 1 Ceratoz3 0.443\n 2 FSET     0.429\n 3 HMIN     0.486\n 4 MEGR     0.543\n 5 NCOR     0.5  \n 6 Oppiminu 0.429\n 7 Oribatl1 0.429\n 8 PWIL     0.486\n 9 TVEL     0.557\n10 Trhypch1 0.457\n```\n\n\n:::\n\n```{.r .cell-code}\n## how about: PWIL \n```\n:::\n\n\nLet's choose just one species as an example. \nI've chosen one where the relationship with water is rather strong, and for which presence and absence are roughly balanced. \nThis is just to make the example clear.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npwil_data <- mite_data_long_transformed |> \n  filter(spp == \"PWIL\")\n\npwil_data |> \n  ggplot(aes(x = water, y = presabs)) + geom_point() + \n  stat_smooth(method = glm, method.args = list(family = \"binomial\")) + \n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Probability of occurrance of one mite species, as a fuction of water content of the soil](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add the spatial coordinates:\n\npwil_spatial <- bind_cols(pwil_data, mite.xy)\n\npwil_spatial |> \n  ggplot(aes(x = x, y = y, fill = as.factor(presabs))) + \n  geom_point(size = 3, pch = 21, stroke = 1) + \n  scale_fill_brewer(type = \"qual\", palette = \"Dark2\") + \n  theme_minimal() + \n  coord_fixed() + \n  labs(fill = \"Pres/Abs\")\n```\n\n::: {.cell-output-display}\n![Presence-absence data for mite species \"PWIL\", at the spatial location of each point.](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\nWe'll look at two possibilities in turn:  \n\n1. A nonlinear function of one variable\n1. A smooth function of distance\n\n# Smooth function of one variable\n\n## Write the model\n\n\n$$\n\\begin{align}\n\\mathsf{Pr}(y_i = 1) &\\sim \\mathsf{Bernoulli}(p_i)\\\\\n\\mathsf{logit}(p_i) &= a + f_i\\\\ \nf_i &\\sim \\mathsf{multivariate\\ normal}(0, K(x | \\theta)) \\\\\n  K(x | \\alpha, \\rho, \\sigma)_{i, j}\n&= \\alpha^2\n\\exp \\left(\n- \\dfrac{1}{2 \\rho^2} \\sum_{d=1}^D (x_{i,d} - x_{j,d})^2\n\\right)\n+ \\delta_{i, j} \\sigma^2,\n\\end{align}\n$$\n\nThat's the general notation for D dimensions. In our case we're looking at something much simpler.\n\n$$\n\\begin{align}\n\\mathsf{Pr}(y_i = 1) &\\sim \\mathsf{Bernoulli}(p_i)\\\\\n\\mathsf{logit}(p_i) &= a + f_i\\\\ \nf_i &\\sim \\mathsf{Multivariate\\ Normal}(0, K(x | \\theta)) \\\\\n  K(x | \\alpha, \\rho, \\sigma)_{i, j}\n&= \\alpha^2\ne^{\n\\frac{-(\\text{water}_i - \\text{water}_j)^2}{2 \\rho^2}}\n+ \\delta_{i, j} \\sigma^2 \\\\\n\\rho &\\sim \\mathsf{Inverse\\ Gamma}(5, 14) \\\\\n\\alpha &\\sim \\mathsf{Normal}(0, .8) \\\\\na &\\sim \\mathsf{Normal}(0, .2) \\\\\n\\end{align}\n$$\n\nHere's an interpretation of the parameters of this model: \n\n* $a^2$ is the maximum covariance between two points\n* $\\rho$ tells us how quickly that covariance goes down as two samples become more different in their water amount\n* $\\delta_{i, j} \\sigma^2$ adds the variances along the diagonal\n\nSee the explanation of this function in the [Stan User's guide](https://mc-stan.org/docs/stan-users-guide/gaussian-processes.html#gaussian-process-regression). \n\n## Simulate to understand it\n\nHere is the brms code that replicates the mathematical model above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## data\nglimpse(pwil_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 70\nColumns: 10\n$ SubsDens  <dbl> 39.18, 54.99, 46.07, 48.19, 23.55, 57.32, 36.95, 80.59, 61.4…\n$ WatrCont  <dbl> 350.15, 434.81, 371.72, 360.50, 204.13, 311.55, 378.93, 266.…\n$ Substrate <fct> Sphagn1, Litter, Interface, Sphagn1, Sphagn1, Sphagn1, Sphag…\n$ Shrub     <ord> Few, Few, Few, Few, Few, Few, Few, Many, Many, Many, Many, F…\n$ Topo      <fct> Hummock, Hummock, Hummock, Hummock, Hummock, Hummock, Hummoc…\n$ plot_id   <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…\n$ spp       <chr> \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWI…\n$ abd       <int> 1, 1, 2, 0, 5, 1, 0, 3, 0, 1, 6, 1, 1, 5, 1, 0, 1, 1, 2, 7, …\n$ presabs   <dbl> 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, …\n$ water     <dbl> -0.60485714, 0.24174286, -0.38915714, -0.50135714, -2.065057…\n```\n\n\n:::\n\n```{.r .cell-code}\n## formula\npwil_water_bf <- bf(presabs ~ 1 + water + gp(water),\n                    family = bernoulli(link = \"logit\"))\n\n\n## prior\nget_prior(pwil_water_bf, data = pwil_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                         prior     class    coef group resp dpar nlpar lb ub\n                        (flat)         b                                    \n                        (flat)         b   water                            \n          student_t(3, 0, 2.5) Intercept                                    \n                        (flat)    lscale                                0   \n inv_gamma(1.494197, 0.056607)    lscale gpwater                        0   \n          student_t(3, 0, 2.5)      sdgp                                0   \n          student_t(3, 0, 2.5)      sdgp gpwater                        0   \n tag       source\n          default\n     (vectorized)\n          default\n          default\n          default\n          default\n     (vectorized)\n```\n\n\n:::\n\n```{.r .cell-code}\npwil_water_prior <- c(\n  set_prior(\"normal(0, 0.5)\", class = \"b\", coef = \"water\"),\n  set_prior(\"normal(0, 0.2)\", class = \"Intercept\"),\n  set_prior(\"normal(0, 0.8)\", class = \"sdgp\", lb = 0),\n  set_prior(\"inv_gamma(5, 14)\", class = \"lscale\", coef = \"gpwater\")\n)\n\nstancode(pwil_water_bf, prior = pwil_water_prior, data = pwil_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n// generated with brms 2.23.0\nfunctions {\n  /* compute a latent Gaussian process with squared exponential kernel\n   * Args:\n   *   x: array of continuous predictor values\n   *   sdgp: marginal SD parameter\n   *   lscale: length-scale parameter\n   *   zgp: vector of independent standard normal variables\n   * Returns:\n   *   a vector to be added to the linear predictor\n   */\n  vector gp_exp_quad(data array[] vector x, real sdgp, vector lscale, vector zgp) {\n    int Dls = rows(lscale);\n    int N = size(x);\n    matrix[N, N] cov;\n    if (Dls == 1) {\n      // one dimensional or isotropic GP\n      cov = gp_exp_quad_cov(x, sdgp, lscale[1]);\n    } else {\n      // multi-dimensional non-isotropic GP\n      cov = gp_exp_quad_cov(x[, 1], sdgp, lscale[1]);\n      for (d in 2:Dls) {\n        cov = cov .* gp_exp_quad_cov(x[, d], 1, lscale[d]);\n      }\n    }\n    for (n in 1:N) {\n      // deal with numerical non-positive-definiteness\n      cov[n, n] += 1e-12;\n    }\n    return cholesky_decompose(cov) * zgp;\n  }\n}\ndata {\n  int<lower=1> N;  // total number of observations\n  array[N] int Y;  // response variable\n  int<lower=1> K;  // number of population-level effects\n  matrix[N, K] X;  // population-level design matrix\n  int<lower=1> Kc;  // number of population-level effects after centering\n  // data related to GPs\n  int<lower=1> Kgp_1;  // number of sub-GPs (equal to 1 unless 'by' was used)\n  int<lower=1> Dgp_1;  // GP dimension\n  // number of latent GP groups\n  int<lower=1> Nsubgp_1;\n  // indices of latent GP groups per observation\n  array[N] int<lower=1> Jgp_1;\n  array[Nsubgp_1] vector[Dgp_1] Xgp_1;  // covariates of the GP\n  int prior_only;  // should the likelihood be ignored?\n}\ntransformed data {\n  matrix[N, Kc] Xc;  // centered version of X without an intercept\n  vector[Kc] means_X;  // column means of X before centering\n  for (i in 2:K) {\n    means_X[i - 1] = mean(X[, i]);\n    Xc[, i - 1] = X[, i] - means_X[i - 1];\n  }\n}\nparameters {\n  vector[Kc] b;  // regression coefficients\n  real Intercept;  // temporary intercept for centered predictors\n  vector<lower=0>[Kgp_1] sdgp_1;  // GP standard deviation parameters\n  array[Kgp_1] vector<lower=0>[1] lscale_1;  // GP length-scale parameters\n  vector[Nsubgp_1] zgp_1;  // latent variables of the GP\n}\ntransformed parameters {\n  // prior contributions to the log posterior\n  real lprior = 0;\n  lprior += normal_lpdf(b[1] | 0, 0.5);\n  lprior += normal_lpdf(Intercept | 0, 0.2);\n  lprior += normal_lpdf(sdgp_1 | 0, 0.8)\n    - 1 * normal_lccdf(0 | 0, 0.8);\n  lprior += inv_gamma_lpdf(lscale_1[1][1] | 5, 14);\n}\nmodel {\n  // likelihood including constants\n  if (!prior_only) {\n    vector[Nsubgp_1] gp_pred_1 = gp_exp_quad(Xgp_1, sdgp_1[1], lscale_1[1], zgp_1);\n    // initialize linear predictor term\n    vector[N] mu = rep_vector(0.0, N);\n    mu += Intercept + gp_pred_1[Jgp_1];\n    target += bernoulli_logit_glm_lpmf(Y | Xc, mu, b);\n  }\n  // priors including constants\n  target += lprior;\n  target += std_normal_lpdf(zgp_1);\n}\ngenerated quantities {\n  // actual population-level intercept\n  real b_Intercept = Intercept - dot_product(means_X, b);\n}\n```\n\n\n:::\n\n```{.r .cell-code}\n## simulate from the model\npwil_prior_brm <- brm(pwil_water_bf, \n                      prior = pwil_water_prior, \n                      data = pwil_data, \n                      sample_prior = \"only\",\n                      cores = 4, \n                      file = here::here(\"topics/04_gp/pwil_prior_brm.rds\"),\n                      file_refit = \"on_change\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCompiling Stan program...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTrying to compile a simple C file\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning /usr/lib/R/bin/R CMD SHLIB foo.c\nusing C compiler: ‘gcc (Ubuntu 11.4.0-1ubuntu1~22.04.2) 11.4.0’\ngcc -I\"/usr/share/R/include\" -DNDEBUG   -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/Rcpp/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/unsupported\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/BH/include\" -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/src/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppParallel/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/rstan/include\" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-xupQTd/r-base-4.5.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o\nIn file included from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Core:19,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Dense:1,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22,\n                 from <command-line>:\n/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: cmath: No such file or directory\n  679 | #include <cmath>\n      |          ^~~~~~~\ncompilation terminated.\nmake: *** [/usr/lib/R/etc/Makeconf:202: foo.o] Error 1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nStart sampling\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx_value_df <- tibble::enframe(\n  x = seq(from = -3, to = 5, length.out = 20),\n  name = \"i\", value = \"water\")\n\nx_value_df |> \n  tidybayes::add_epred_draws(pwil_prior_brm, ndraws = 40) |> \n  ggplot(aes(x= water, y = .epred, group = .draw)) + \n  geom_line()+\n  coord_cartesian(ylim = c(0, 1))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n## fit this model to data:\n\nWith a working simulation, we can now adapt the model to handle real data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## simulate from the model\npwil_posterior_brm <- brm(pwil_water_bf, \n                      prior = pwil_water_prior, \n                      data = pwil_data, \n                      sample_prior = \"no\",\n                      cores = 4, \n                      refresh = 0,\n                      file = here::here(\"topics/04_gp/pwil_posterior_brm.rds\"),\n                      file_refit = \"on_change\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCompiling Stan program...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTrying to compile a simple C file\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning /usr/lib/R/bin/R CMD SHLIB foo.c\nusing C compiler: ‘gcc (Ubuntu 11.4.0-1ubuntu1~22.04.2) 11.4.0’\ngcc -I\"/usr/share/R/include\" -DNDEBUG   -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/Rcpp/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/unsupported\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/BH/include\" -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/src/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppParallel/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/rstan/include\" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-xupQTd/r-base-4.5.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o\nIn file included from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Core:19,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Dense:1,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22,\n                 from <command-line>:\n/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: cmath: No such file or directory\n  679 | #include <cmath>\n      |          ^~~~~~~\ncompilation terminated.\nmake: *** [/usr/lib/R/etc/Makeconf:202: foo.o] Error 1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nStart sampling\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx_value_df <- tibble::enframe(\n  x = seq(from = -3, to = 5, length.out = 20),\n  name = \"i\", value = \"water\")\n\nx_value_df |> \n  tidybayes::add_epred_draws(pwil_posterior_brm, ndraws = 50) |> \n  ggplot(aes(x= water, y = .epred)) + \n  stat_lineribbon() + \n  coord_cartesian(ylim = c(0, 1))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nThis can also be accomplished with the function `brms::conditional_effects`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconditional_effects(pwil_posterior_brm)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nIgnoring unknown labels:\n• fill : \"NA\"\n• colour : \"NA\"\nIgnoring unknown labels:\n• fill : \"NA\"\n• colour : \"NA\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n<!-- ![](topics/04_gp/pwil_water.png) -->\n\n# Spatial predictions\n\n### Prior predictive simulations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## data\nglimpse(pwil_spatial)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 70\nColumns: 12\n$ SubsDens  <dbl> 39.18, 54.99, 46.07, 48.19, 23.55, 57.32, 36.95, 80.59, 61.4…\n$ WatrCont  <dbl> 350.15, 434.81, 371.72, 360.50, 204.13, 311.55, 378.93, 266.…\n$ Substrate <fct> Sphagn1, Litter, Interface, Sphagn1, Sphagn1, Sphagn1, Sphag…\n$ Shrub     <ord> Few, Few, Few, Few, Few, Few, Few, Many, Many, Many, Many, F…\n$ Topo      <fct> Hummock, Hummock, Hummock, Hummock, Hummock, Hummock, Hummoc…\n$ plot_id   <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…\n$ spp       <chr> \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWIL\", \"PWI…\n$ abd       <int> 1, 1, 2, 0, 5, 1, 0, 3, 0, 1, 6, 1, 1, 5, 1, 0, 1, 1, 2, 7, …\n$ presabs   <dbl> 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, …\n$ water     <dbl> -0.60485714, 0.24174286, -0.38915714, -0.50135714, -2.065057…\n$ x         <dbl> 0.20, 1.00, 1.20, 1.40, 2.40, 1.80, 0.05, 2.00, 2.00, 1.20, …\n$ y         <dbl> 0.1, 0.1, 0.3, 0.5, 0.7, 0.9, 1.1, 1.3, 1.5, 1.7, 1.9, 2.1, …\n```\n\n\n:::\n\n```{.r .cell-code}\n## formula\npwil_spatial_bf <- bf(presabs ~ 1 + gp(x, y),\n                    family = bernoulli(link = \"logit\"))\n\n\n## prior\nget_prior(pwil_spatial_bf, data = pwil_spatial)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                         prior     class coef group resp dpar nlpar lb ub tag\n          student_t(3, 0, 2.5) Intercept                                     \n                        (flat)    lscale                             0       \n inv_gamma(1.738884, 0.095803)    lscale gpxy                        0       \n          student_t(3, 0, 2.5)      sdgp                             0       \n          student_t(3, 0, 2.5)      sdgp gpxy                        0       \n       source\n      default\n      default\n      default\n      default\n (vectorized)\n```\n\n\n:::\n\n```{.r .cell-code}\npwil_spatial_prior <- c(\n  set_prior(\"normal(0, 0.2)\", class = \"Intercept\"),\n  set_prior(\"normal(0, 0.8)\", class = \"sdgp\", lb = 0),\n  set_prior(\"inv_gamma(5, 14)\", class = \"lscale\", coef = \"gpxy\")\n)\n\n# stancode(pwil_spatial_bf, prior = pwil_spatial_prior, data = pwil_spatial)\n\n## simulate from the model\npwil_spatial_brm <- brm(pwil_spatial_bf, \n                      prior = pwil_spatial_prior, \n                      data = pwil_spatial, \n                      sample_prior = \"yes\",\n                      cores = 4, \n                      refresh = 0,\n                      file = here::here(\"topics/04_gp/pwil_spatial_brm.rds\"),\n                      file_refit = \"on_change\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in gsub(\"\\\\[[[:digit:]]+\\\\]\", paste0(\"__\", ind), par): argument\n'replacement' has length > 1 and only the first element will be used\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCompiling Stan program...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTrying to compile a simple C file\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning /usr/lib/R/bin/R CMD SHLIB foo.c\nusing C compiler: ‘gcc (Ubuntu 11.4.0-1ubuntu1~22.04.2) 11.4.0’\ngcc -I\"/usr/share/R/include\" -DNDEBUG   -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/Rcpp/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/unsupported\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/BH/include\" -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/src/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppParallel/include/\"  -I\"/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/rstan/include\" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-xupQTd/r-base-4.5.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o\nIn file included from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Core:19,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/Dense:1,\n                 from /home/andrew/R/x86_64-pc-linux-gnu-library/4.5/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22,\n                 from <command-line>:\n/home/andrew/R/x86_64-pc-linux-gnu-library/4.5/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: cmath: No such file or directory\n  679 | #include <cmath>\n      |          ^~~~~~~\ncompilation terminated.\nmake: *** [/usr/lib/R/etc/Makeconf:202: foo.o] Error 1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nStart sampling\n```\n\n\n:::\n:::\n\n\nTo visualize predictions we need a grid of points to predict along:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrid_points <- modelr::data_grid(mite.xy, \n                                 x = modelr::seq_range(x, by = .5),\n                                 y = modelr::seq_range(y, by = .5)) \n\ngrid_points |> \n  ggplot(aes(x = x, y = y)) + \n  geom_point() + \n  coord_fixed()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n:::{.callout-warning}\n## CAUTION: Slow\nThe model below, over 70 points, is the slowest model we've seen so far and takes about 1 minute on my (Andrew's) laptop.\n:::\n\nplot the effect in space:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrid_points <- modelr::data_grid(mite.xy, \n                                 x = modelr::seq_range(x, by = .5),\n                                 y = modelr::seq_range(y, by = .5)) \n\ngrid_points |> \n  ggplot(aes(x = x, y = y)) + \n  geom_point() + \n  coord_fixed()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npwil_spatial_post_pred <- grid_points |> \n  add_epred_draws(pwil_spatial_brm, draws = 10)\n\npwil_spatial_post_pred |> \n  summarize(avg_pred = mean(.epred)) |> \n  ungroup() |> \n  ggplot(aes(x = x, y = y, fill = avg_pred)) + \n  geom_tile() + \n  geom_point(aes(x = x,\n                 y = y,\n                 col = as.factor(presabs)),\n             inherit.aes = FALSE,\n             data = pwil_spatial,\n             # pch = 21 ,\n             # size = 2.5,\n             # stroke = .3,\n             # colour = \"lightblue\"\n             ) + \n  scale_fill_viridis_c(option = \"rocket\") +\n  coord_fixed()+\n  theme_minimal() + \n  labs(fill = \"Pr(y=1)\") + \n  NULL \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'x', 'y'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}