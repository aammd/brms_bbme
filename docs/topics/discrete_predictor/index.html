<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="fitting a model with discrete predictors.">

<title>Palmer penguins and discrete predictors – Generalized Linear Hierarchical models in brms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-83ef79ec45755748b848d52875005fa0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Generalized Linear Hierarchical models in brms</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
    <a href="https://github.com/bios2/hiermod" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-packages-and-data" id="toc-load-packages-and-data" class="nav-link active" data-scroll-target="#load-packages-and-data">Load packages and data</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration">Data exploration</a></li>
  <li><a href="#a-simple-model" id="toc-a-simple-model" class="nav-link" data-scroll-target="#a-simple-model">A simple model</a></li>
  <li><a href="#plotting-parameters." id="toc-plotting-parameters." class="nav-link" data-scroll-target="#plotting-parameters.">Plotting parameters.</a></li>
  <li><a href="#posterior-predictions-the-easy-way-to-check-your-model" id="toc-posterior-predictions-the-easy-way-to-check-your-model" class="nav-link" data-scroll-target="#posterior-predictions-the-easy-way-to-check-your-model">Posterior predictions: the easy way to check your model</a>
  <ul class="collapse">
  <li><a href="#pseudocode" id="toc-pseudocode" class="nav-link" data-scroll-target="#pseudocode">Pseudocode</a></li>
  <li><a href="#posterior-prediction-in-r" id="toc-posterior-prediction-in-r" class="nav-link" data-scroll-target="#posterior-prediction-in-r">Posterior prediction in R</a></li>
  </ul></li>
  <li><a href="#different-groups-are-different" id="toc-different-groups-are-different" class="nav-link" data-scroll-target="#different-groups-are-different">Different groups are different</a></li>
  <li><a href="#adding-a-discrete-predictor-variable." id="toc-adding-a-discrete-predictor-variable." class="nav-link" data-scroll-target="#adding-a-discrete-predictor-variable.">Adding a discrete predictor variable.</a>
  <ul class="collapse">
  <li><a href="#sampling-the-species-model" id="toc-sampling-the-species-model" class="nav-link" data-scroll-target="#sampling-the-species-model">Sampling the species model</a></li>
  <li><a href="#visualizing-species-using-tidybayes" id="toc-visualizing-species-using-tidybayes" class="nav-link" data-scroll-target="#visualizing-species-using-tidybayes">Visualizing species – using <code>tidybayes</code></a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  <li><a href="#optional" id="toc-optional" class="nav-link" data-scroll-target="#optional">Optional!</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Palmer penguins and discrete predictors</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>

<div>
  <div class="description">
    <p>fitting a model with discrete predictors.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this section we’re going to look at a simple model with a single predictor variable which divides the dataset into categories. In this example, categories are treated as “fixed” effects.</p>
<section id="load-packages-and-data" class="level2">
<h2 class="anchored" data-anchor-id="load-packages-and-data">Load packages and data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(brms))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tidybayes'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:brms':

    dstudent_t, pstudent_t, qstudent_t, rstudent_t</code></pre>
</div>
</div>
</section>
<section id="data-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-exploration">Data exploration</h2>
<p>Let’s start by taking a look at the Palmer Penguin dataset, specifically the distribution of observations of bill size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>bill_dep)) <span class="sc">+</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> .<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2 rows containing non-finite outside the scale range
(`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Histogram of bill depth for all the penguins in the Palmer Penguin dataset.</figcaption>
</figure>
</div>
</div>
</div>
<p>There’s quite a lot of variation in these measurements, with a suggestion of perhaps more than one peak in this distribution.</p>
<p>There’s also some NA values – we’ll drop them before we move on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="ot">&lt;-</span> penguins <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(bill_dep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-simple-model" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-model">A simple model</h2>
<p><span class="math display">\[
\begin{align}
\text{Bill depth} &amp;\sim \text{Normal}(\mu, \sigma)\\
\mu &amp;\sim \text{Normal}(17, 2) \\
\sigma &amp;\sim \text{Exponential}(1) \\
\end{align}
\]</span></p>
<p>let’s express the same model in brms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## formula</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>bill_bf <span class="ot">&lt;-</span> <span class="fu">bf</span>(bill_dep <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="do">## prior</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bill_bf, <span class="at">data =</span> penguins_noNAbill)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   prior     class coef group resp dpar nlpar lb ub tag  source
 student_t(3, 17.3, 2.5) Intercept                                      default
    student_t(3, 0, 2.5)     sigma                             0        default</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bill_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">17</span>, <span class="dv">2</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(.<span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">lb =</span> <span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>bill_prior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            prior     class coef group resp dpar nlpar   lb   ub tag source
    normal(17, 2) Intercept                            &lt;NA&gt; &lt;NA&gt;       user
 exponential(0.5)     sigma                               0 &lt;NA&gt;       user</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fit</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>bill_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(bill_bf, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> penguins_noNAbill, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior =</span> bill_prior,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">refresh =</span> <span class="dv">0</span>L,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/discrete_predictor/bill_brm.rds"</span>), </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>bill_brm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: bill_dep ~ 1 
   Data: penguins (Number of observations: 342) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    17.15      0.11    16.94    17.36 1.00     2888     2591

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.98      0.08     1.84     2.13 1.00     3354     2693

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Some things to notice about the process and results above:</p>
<ul>
<li>similar to yesterday’s example, we’ve fit a univariate model to these data. However, because it is a <em>gaussian</em> model, it requires two parameters: a mean and a standard deviation.</li>
<li>although the priors are close to a visual inspection of the histogram, the assumption here is that the prior parameters come from expertise or prior simulations, NOT from looking at the data before modelling!</li>
<li>note that we have not tried to drop NA values, but brms has done it on its own and warned us.</li>
</ul>
<p>We can use the <a href="https://mc-stan.org/posterior/"><code>posterior</code> package</a> to extract and conveniently summarize the draws from the distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## summarize the samples for each parameter into a nice table</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>bill_brm <span class="sc">|&gt;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  posterior<span class="sc">::</span><span class="fu">summarise_draws</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">b_Intercept</td>
<td style="text-align: right;">17.150936</td>
<td style="text-align: right;">17.150233</td>
<td style="text-align: right;">0.1071332</td>
<td style="text-align: right;">0.1037355</td>
<td style="text-align: right;">16.9752916</td>
<td style="text-align: right;">17.328560</td>
<td style="text-align: right;">1.0004088</td>
<td style="text-align: right;">2888.342</td>
<td style="text-align: right;">2590.755</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">1.978250</td>
<td style="text-align: right;">1.975331</td>
<td style="text-align: right;">0.0751664</td>
<td style="text-align: right;">0.0755603</td>
<td style="text-align: right;">1.8587321</td>
<td style="text-align: right;">2.107719</td>
<td style="text-align: right;">1.0003574</td>
<td style="text-align: right;">3354.310</td>
<td style="text-align: right;">2692.926</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">17.150936</td>
<td style="text-align: right;">17.150233</td>
<td style="text-align: right;">0.1071332</td>
<td style="text-align: right;">0.1037355</td>
<td style="text-align: right;">16.9752916</td>
<td style="text-align: right;">17.328560</td>
<td style="text-align: right;">1.0004088</td>
<td style="text-align: right;">2888.342</td>
<td style="text-align: right;">2590.755</td>
</tr>
<tr class="even">
<td style="text-align: left;">prior_Intercept</td>
<td style="text-align: right;">16.990264</td>
<td style="text-align: right;">16.989851</td>
<td style="text-align: right;">1.9953338</td>
<td style="text-align: right;">2.0734243</td>
<td style="text-align: right;">13.7275726</td>
<td style="text-align: right;">20.231049</td>
<td style="text-align: right;">0.9997240</td>
<td style="text-align: right;">3751.547</td>
<td style="text-align: right;">3766.682</td>
</tr>
<tr class="odd">
<td style="text-align: left;">prior_sigma</td>
<td style="text-align: right;">2.029725</td>
<td style="text-align: right;">1.425058</td>
<td style="text-align: right;">2.0517451</td>
<td style="text-align: right;">1.4376533</td>
<td style="text-align: right;">0.1083177</td>
<td style="text-align: right;">6.190085</td>
<td style="text-align: right;">0.9999286</td>
<td style="text-align: right;">3714.513</td>
<td style="text-align: right;">3796.457</td>
</tr>
<tr class="even">
<td style="text-align: left;">lprior</td>
<td style="text-align: right;">-3.298640</td>
<td style="text-align: right;">-3.296940</td>
<td style="text-align: right;">0.0381071</td>
<td style="text-align: right;">0.0377788</td>
<td style="text-align: right;">-3.3654329</td>
<td style="text-align: right;">-3.237870</td>
<td style="text-align: right;">1.0006126</td>
<td style="text-align: right;">3311.303</td>
<td style="text-align: right;">2371.514</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">-721.102922</td>
<td style="text-align: right;">-720.794259</td>
<td style="text-align: right;">1.0160055</td>
<td style="text-align: right;">0.7080779</td>
<td style="text-align: right;">-723.1015945</td>
<td style="text-align: right;">-720.162162</td>
<td style="text-align: right;">1.0032464</td>
<td style="text-align: right;">1666.202</td>
<td style="text-align: right;">2265.619</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="plotting-parameters." class="level2">
<h2 class="anchored" data-anchor-id="plotting-parameters.">Plotting parameters.</h2>
<p>We don’t have one value for each of our unknown numbers: we have thousands. We need to get a sense of what these possible values mean scientifically. An excellent way to do this is by making as many pictures as possible. We will start with making plots of specific parameters.</p>
<p>We can look at the distributions easily using the <code>bayesplot</code> package.</p>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="st">"Intercept"</span>)  <span class="sc">+</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="st">"sigma"</span>) <span class="sc">+</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="index_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<p>Notice that the distributions do not have the same shape as the prior– this is particularly true for <span class="math inline">\(\sigma\)</span>.</p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"prior_Intercept"</span>))  <span class="sc">+</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"sigma"</span>, <span class="st">"prior_sigma"</span>))  <span class="sc">+</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="index_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="posterior-predictions-the-easy-way-to-check-your-model" class="level2">
<h2 class="anchored" data-anchor-id="posterior-predictions-the-easy-way-to-check-your-model">Posterior predictions: the easy way to check your model</h2>
<p>In my experience, ecologists (rightly!) care a great deal about model diagnostics. And with good reason: you need to know how much to trust a model before using it to make a scientific claim. Bayes offers a straightforward way to show how well a model is doing: plot model predictions, and compare them to the observed data. This involves using the model as a data generating machine, which we’ll look at next.</p>
<section id="pseudocode" class="level3">
<h3 class="anchored" data-anchor-id="pseudocode">Pseudocode</h3>
<p>Here is the procedure for generating posterior predictions:</p>
<ul>
<li>Select some posterior posterior draws.</li>
<li>For each draw, extract all the model parameters</li>
<li>For each draw, plug the sampled parameters in to the model. Use all the same predictors, factors, etc as the original model.</li>
<li>For each draw, draw a random dataset that is the <em>same size and shape</em> as your original data.</li>
<li>Overlay the simulated datasets on the observed data.</li>
</ul>
</section>
<section id="posterior-prediction-in-r" class="level3">
<h3 class="anchored" data-anchor-id="posterior-prediction-in-r">Posterior prediction in R</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># just get some draws</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>draws_matrix <span class="ot">&lt;-</span> posterior<span class="sc">::</span><span class="fu">as_draws_matrix</span>(bill_brm)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="do">## set up a matrix. for every posterior sample, </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="do">## (that is, for a value of mu and a value of sigma) </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="do">## draw a whole fake dataset from a normal distribution with that mean and sd. </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>nsamples <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>yrep <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">length</span>(penguins_noNAbill<span class="sc">$</span>bill_dep), <span class="at">nrow =</span> nsamples)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># pick some random rows</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>chosen_samples <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(draws_matrix), </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">replace =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">size =</span> nsamples)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>subset_draws <span class="ot">&lt;-</span> draws_matrix[chosen_samples,]</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nsamples){</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a> yrep[r,] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(penguins_noNAbill<span class="sc">$</span>bill_dep), </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mean =</span> subset_draws[r, <span class="st">"Intercept"</span>], </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sd =</span> subset_draws[r, <span class="st">"sigma"</span>])</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> penguins_noNAbill<span class="sc">$</span>bill_dep,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                            <span class="at">yrep =</span> yrep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is the manual approach, which demonstrates the entire process explicitly. However, thanks to the power of brms, this can also be accomplished in a single line:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bill_brm, <span class="at">type =</span> <span class="st">"dens_overlay"</span>, <span class="at">ndraws =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EXERCISE
</div>
</div>
<div class="callout-body-container callout-body">
<p>Look at the other graphical posterior predictive checks available in the <code>bayesplot</code> package by examining <a href="https://mc-stan.org/bayesplot/articles/graphical-ppcs.html">the vignette</a>. Experiment with some different possibilities for these data.</p>
</div>
</div>
<p>The posterior predictive distribution gives us a straightfoward way to test our model’s performance:</p>
<ol type="1">
<li>we use the model to generate fake observations.</li>
<li>plot these on top of the real data</li>
<li>if the data is a really poor match, we know our model has a distorted view of the world.</li>
</ol>
</section>
</section>
<section id="different-groups-are-different" class="level2">
<h2 class="anchored" data-anchor-id="different-groups-are-different">Different groups are different</h2>
<p>let’s add in differences among species</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bill_dep, <span class="at">fill =</span> species))<span class="sc">+</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2 rows containing non-finite outside the scale range
(`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can see that the distribution is probably three different distributions, all placed together.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes scientists will plot histograms of data at the beginning of a research project, and use the histogram to decide if their data are “normally distributed” or not. This is not helpful! Instead, decide on a model first, and ask yourself what kind of data you expect.</p>
</div>
</div>
</section>
<section id="adding-a-discrete-predictor-variable." class="level2">
<h2 class="anchored" data-anchor-id="adding-a-discrete-predictor-variable.">Adding a discrete predictor variable.</h2>
<p>Here we extend the model to give each species a different average bill depth. How many parameters are in this model?</p>
<p><span class="math display">\[
\begin{align}
\text{Bill depth}_{i} &amp;\sim \text{Normal}(\mu_{\text{species}[i]}, \sigma) \\
\mu_{\text{species}} &amp;\sim \text{Normal}(17, 2) \\
\sigma &amp;\sim \text{Exponential}(2) \\
\end{align}
\]</span></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quick detour : vector indexing
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A <strong>very</strong> useful technique, in both R and Stan, is transforming a vector with <em>indexing</em>. Vector indexing requires two vectors: the first contains values we want to select or replicate, the second contains integers giving the positions of the elements we want. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>some_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"taco"</span>, <span class="st">"cat"</span>, <span class="st">"goat"</span>, <span class="st">"cheeze"</span>, <span class="st">"pizza"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>positions <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">5</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>some_values[positions]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "taco"  "taco"  "cat"   "cat"   "goat"  "taco"  "taco"  "pizza"</code></pre>
</div>
</div>
<p>This works for number values as well, and is very useful when you want to do simulations! let’s simulate three groups with different averages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>some_means <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">17</span>, <span class="dv">19</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>some_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"taco"</span>, <span class="st">"cat"</span>, <span class="st">"goat"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>df_of_means <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">index =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="dv">42</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">the_mean =</span> some_means[index],</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">labels =</span> some_labels[index],</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">obs =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(the_mean),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mean =</span> the_mean,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sd =</span> <span class="dv">1</span>))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>df_of_means <span class="sc">|&gt;</span> </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> obs, <span class="at">fill =</span> labels)) <span class="sc">+</span> </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="vector-indexing-in-stan" class="level2">
<h2 class="anchored" data-anchor-id="vector-indexing-in-stan">Vector indexing in Stan</h2>
<p>We can use this very same technique in Stan:</p>
<p>The only difference to the previous model is in the line with the for-loop, which is now replaced with a vectorized expression. This is faster to write and will run faster in Stan. However it’s not possible in every case.</p>
</section>
</div>
</div>
</div>
<section id="sampling-the-species-model" class="level3">
<h3 class="anchored" data-anchor-id="sampling-the-species-model">Sampling the species model</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EXERCISE
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fit one the species-specific model above using brms. TIP: set the formula to be <code>bill_dep ~ 0 + species</code>. 1. What changes do you need to make to the prior? 2. Visualize the posterior with <code>bayesplot</code>. Does it look better than the model without species? How can you tell?</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
SOLUTION
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## formula</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>bill_spp_bf <span class="ot">&lt;-</span> <span class="fu">bf</span>(bill_dep <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> species, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="do">## prior</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bill_spp_bf, <span class="at">data =</span> penguins_noNAbill)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior class             coef group resp dpar nlpar lb ub tag
               (flat)     b                                                 
               (flat)     b    speciesAdelie                                
               (flat)     b speciesChinstrap                                
               (flat)     b    speciesGentoo                                
 student_t(3, 0, 2.5) sigma                                         0       
       source
      default
 (vectorized)
 (vectorized)
 (vectorized)
      default</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>bill_spp_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">17</span>, <span class="dv">2</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(.<span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">lb =</span> <span class="dv">0</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>bill_spp_prior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            prior class coef group resp dpar nlpar   lb   ub tag source
    normal(17, 2)     b                            &lt;NA&gt; &lt;NA&gt;       user
 exponential(0.5) sigma                               0 &lt;NA&gt;       user</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fit</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>bill_spp_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(bill_spp_bf, </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> penguins_noNAbill, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior =</span> bill_spp_prior,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">refresh =</span> <span class="dv">0</span>L,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/discrete_predictor/bill_spp_brm.rds"</span>), </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>bill_spp_brm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: bill_dep ~ 0 + species 
   Data: penguins_noNAbill (Number of observations: 342) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
speciesAdelie       18.34      0.09    18.17    18.52 1.00     4590     3481
speciesChinstrap    18.41      0.14    18.15    18.69 1.00     4549     3157
speciesGentoo       14.99      0.10    14.79    15.19 1.00     4446     3037

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.12      0.04     1.04     1.21 1.00     4221     3572

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>and we can repeat the posterior checking from before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior predictive check</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bill_spp_brm, <span class="at">type =</span> <span class="st">"dens_overlay"</span>, <span class="at">ndraws =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The predicted distribution is now much more like the real data!</p>
</div>
</div>
</div>
<section id="further-questions-challenges" class="level4">
<h4 class="anchored" data-anchor-id="further-questions-challenges">Further questions &amp; challenges</h4>
<ul>
<li>This model assumes that the <span class="math inline">\(\sigma\)</span> parameter is the same for all three species. Can you relax that assumption?</li>
<li>I recommended that you remove the intercept from the model using <code>bill_dep ~ 0 + species</code>. What changes if you put it back in? why?</li>
</ul>
</section>
</section>
<section id="visualizing-species-using-tidybayes" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-species-using-tidybayes">Visualizing species – using <code>tidybayes</code></h3>
<p>We can also make figures for each individual species. Here we will move away from using <code>bayesplot</code> and try to visualize our posterior using the handy functions in the <a href="https://mjskay.github.io/tidybayes/"><code>tidybayes</code> package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  tidybayes<span class="sc">::</span><span class="fu">add_predicted_rvars</span>(bill_spp_brm, <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> .prediction, <span class="at">y =</span> species, <span class="at">fill =</span> species)) <span class="sc">+</span> </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_slab</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can visualize the uncertainty in predicted values AND in group means :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> penguins_noNAbill <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">data_grid</span>(species)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_epred_draws</span>(bill_spp_brm)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span>  grid <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_predicted_draws</span>(bill_spp_brm)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> species, <span class="at">x =</span> bill_dep)) <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_interval</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction), <span class="at">data =</span> preds) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="fu">aes</span>(<span class="at">x =</span> .epred), <span class="at">data =</span> means, <span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">66</span>, .<span class="dv">95</span>), <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">y =</span> <span class="sc">-</span><span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">height =</span> .<span class="dv">05</span>, <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>() <span class="sc">+</span> </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dark</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercises" class="level3">
<h3 class="anchored" data-anchor-id="exercises">Exercises</h3>
<section id="level-1" class="level4">
<h4 class="anchored" data-anchor-id="level-1">Level 1</h4>
<ul>
<li>repeat this activity for another variable in the dataset. Does the same code work on bill length? What about body size? What would you change about the model (if anything)</li>
<li>use bayesplot to examine the fit of body size to these data.</li>
</ul>
</section>
<section id="level-2" class="level4">
<h4 class="anchored" data-anchor-id="level-2">Level 2</h4>
<ul>
<li>generate some random groups of your own, with known means. How well does the model fit these data</li>
</ul>
</section>
<section id="level-3" class="level4">
<h4 class="anchored" data-anchor-id="level-3">Level 3</h4>
<ul>
<li>As you can see, the model assumes the same sigma for all species. what if you relax this?</li>
</ul>
</section>
</section>
<section id="optional" class="level3">
<h3 class="anchored" data-anchor-id="optional">Optional!</h3>
<p>Try this on your own data!</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb39" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co">  Palmer penguins and discrete predictors</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> |</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">  fitting a model with discrete predictors.</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: true</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>In this section we're going to look at a simple model with a single predictor variable which divides the dataset into categories. In this example, categories are treated as "fixed" effects. </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load packages and data</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(brms))</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data exploration</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>Let's start by taking a look at the Palmer Penguin dataset, specifically the distribution of observations of bill size.</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Histogram of bill depth for all the penguins in the Palmer Penguin dataset.</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>bill_dep)) <span class="sc">+</span> </span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> .<span class="dv">5</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>There's quite a lot of variation in these measurements, with a suggestion of perhaps more than one peak in this distribution.</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>There's also some NA values -- we'll drop them before we move on:</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="ot">&lt;-</span> penguins <span class="sc">|&gt;</span> </span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(bill_dep)</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## A simple model</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>\text{Bill depth} &amp;\sim \text{Normal}(\mu, \sigma)<span class="sc">\\</span></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>\mu &amp;\sim \text{Normal}(17, 2) <span class="sc">\\</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>\sigma &amp;\sim \text{Exponential}(1) <span class="sc">\\</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>let's express the same model in brms:</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a><span class="do">## formula</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>bill_bf <span class="ot">&lt;-</span> <span class="fu">bf</span>(bill_dep <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a><span class="do">## prior</span></span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bill_bf, <span class="at">data =</span> penguins_noNAbill)</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>bill_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">17</span>, <span class="dv">2</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(.<span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">lb =</span> <span class="dv">0</span>)</span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>bill_prior</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a><span class="do">## fit</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>bill_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(bill_bf, </span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> penguins_noNAbill, </span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior =</span> bill_prior,</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>                <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>                <span class="at">refresh =</span> <span class="dv">0</span>L,</span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>                <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/discrete_predictor/bill_brm.rds"</span>), </span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>                <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>bill_brm</span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>Some things to notice about the process and results above:</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>similar to yesterday's example, we've fit a univariate model to these data. </span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>However, because it is a _gaussian_ model, it requires two parameters: a mean and a standard deviation.</span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>although the priors are close to a visual inspection of the histogram, the assumption here is that the prior parameters come from expertise or prior simulations, NOT from looking at the data before modelling! </span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>note that we have not tried to drop NA values, but brms has done it on its own and warned us.</span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>We can use the <span class="co">[</span><span class="ot">`posterior` package</span><span class="co">](https://mc-stan.org/posterior/)</span> to extract and conveniently summarize the draws from the distribution.  </span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a><span class="do">## summarize the samples for each parameter into a nice table</span></span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>bill_brm <span class="sc">|&gt;</span> </span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>  posterior<span class="sc">::</span><span class="fu">summarise_draws</span>() <span class="sc">|&gt;</span> </span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting parameters. </span></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>We don't have one value for each of our unknown numbers: we have thousands. </span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>We need to get a sense of what these possible values mean scientifically. </span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>An excellent way to do this is by making as many pictures as possible. </span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>We will start with making plots of specific parameters. </span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>We can look at the distributions easily using the <span class="in">`bayesplot`</span> package.</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="st">"Intercept"</span>)  <span class="sc">+</span> </span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">20</span>))</span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="st">"sigma"</span>) <span class="sc">+</span> </span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a>Notice that the distributions do not have the same shape as the prior-- this is particularly true for $\sigma$. </span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"prior_Intercept"</span>))  <span class="sc">+</span> </span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">25</span>))</span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_hist</span>(bill_brm, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"sigma"</span>, <span class="st">"prior_sigma"</span>))  <span class="sc">+</span> </span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>))</span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a><span class="fu">## Posterior predictions: the easy way to check your model</span></span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a>In my experience, ecologists (rightly!) care a great deal about model diagnostics. </span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>And with good reason: you need to know how much to trust a model before using it to make a scientific claim. </span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a>Bayes offers a straightforward way to show how well a model is doing: plot model predictions, and compare them to the observed data. </span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a>This involves using the model as a data generating machine, which we'll look at next.</span>
<span id="cb39-152"><a href="#cb39-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pseudocode</span></span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a>Here is the procedure for generating posterior predictions:</span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Select some posterior posterior draws. </span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For each draw, extract all the model parameters</span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For each draw, plug the sampled parameters in to the model. Use all the same predictors, factors, etc as the original model.</span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For each draw, draw a random dataset that is the _same size and shape_ as your original data. </span>
<span id="cb39-161"><a href="#cb39-161" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Overlay the simulated datasets on the observed data.</span>
<span id="cb39-162"><a href="#cb39-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-163"><a href="#cb39-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-164"><a href="#cb39-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Posterior prediction in R</span></span>
<span id="cb39-165"><a href="#cb39-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-168"><a href="#cb39-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-169"><a href="#cb39-169" aria-hidden="true" tabindex="-1"></a><span class="co"># just get some draws</span></span>
<span id="cb39-170"><a href="#cb39-170" aria-hidden="true" tabindex="-1"></a>draws_matrix <span class="ot">&lt;-</span> posterior<span class="sc">::</span><span class="fu">as_draws_matrix</span>(bill_brm)</span>
<span id="cb39-171"><a href="#cb39-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-172"><a href="#cb39-172" aria-hidden="true" tabindex="-1"></a><span class="do">## set up a matrix. for every posterior sample, </span></span>
<span id="cb39-173"><a href="#cb39-173" aria-hidden="true" tabindex="-1"></a><span class="do">## (that is, for a value of mu and a value of sigma) </span></span>
<span id="cb39-174"><a href="#cb39-174" aria-hidden="true" tabindex="-1"></a><span class="do">## draw a whole fake dataset from a normal distribution with that mean and sd. </span></span>
<span id="cb39-175"><a href="#cb39-175" aria-hidden="true" tabindex="-1"></a>nsamples <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb39-176"><a href="#cb39-176" aria-hidden="true" tabindex="-1"></a>yrep <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">length</span>(penguins_noNAbill<span class="sc">$</span>bill_dep), <span class="at">nrow =</span> nsamples)</span>
<span id="cb39-177"><a href="#cb39-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-178"><a href="#cb39-178" aria-hidden="true" tabindex="-1"></a><span class="co"># pick some random rows</span></span>
<span id="cb39-179"><a href="#cb39-179" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb39-180"><a href="#cb39-180" aria-hidden="true" tabindex="-1"></a>chosen_samples <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(draws_matrix), </span>
<span id="cb39-181"><a href="#cb39-181" aria-hidden="true" tabindex="-1"></a>                         <span class="at">replace =</span> <span class="cn">FALSE</span>,</span>
<span id="cb39-182"><a href="#cb39-182" aria-hidden="true" tabindex="-1"></a>                         <span class="at">size =</span> nsamples)</span>
<span id="cb39-183"><a href="#cb39-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-184"><a href="#cb39-184" aria-hidden="true" tabindex="-1"></a>subset_draws <span class="ot">&lt;-</span> draws_matrix[chosen_samples,]</span>
<span id="cb39-185"><a href="#cb39-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-186"><a href="#cb39-186" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nsamples){</span>
<span id="cb39-187"><a href="#cb39-187" aria-hidden="true" tabindex="-1"></a> yrep[r,] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(penguins_noNAbill<span class="sc">$</span>bill_dep), </span>
<span id="cb39-188"><a href="#cb39-188" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mean =</span> subset_draws[r, <span class="st">"Intercept"</span>], </span>
<span id="cb39-189"><a href="#cb39-189" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sd =</span> subset_draws[r, <span class="st">"sigma"</span>])</span>
<span id="cb39-190"><a href="#cb39-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-191"><a href="#cb39-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-192"><a href="#cb39-192" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> penguins_noNAbill<span class="sc">$</span>bill_dep,</span>
<span id="cb39-193"><a href="#cb39-193" aria-hidden="true" tabindex="-1"></a>                            <span class="at">yrep =</span> yrep)</span>
<span id="cb39-194"><a href="#cb39-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-195"><a href="#cb39-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-196"><a href="#cb39-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-197"><a href="#cb39-197" aria-hidden="true" tabindex="-1"></a>This is the manual approach, which demonstrates the entire process explicitly. </span>
<span id="cb39-198"><a href="#cb39-198" aria-hidden="true" tabindex="-1"></a>However, thanks to the power of brms, this can also be accomplished in a single line:</span>
<span id="cb39-199"><a href="#cb39-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-202"><a href="#cb39-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-203"><a href="#cb39-203" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bill_brm, <span class="at">type =</span> <span class="st">"dens_overlay"</span>, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb39-204"><a href="#cb39-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-205"><a href="#cb39-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-206"><a href="#cb39-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-207"><a href="#cb39-207" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb39-208"><a href="#cb39-208" aria-hidden="true" tabindex="-1"></a><span class="fu">### EXERCISE</span></span>
<span id="cb39-209"><a href="#cb39-209" aria-hidden="true" tabindex="-1"></a>Look at the other graphical posterior predictive checks available in the <span class="in">`bayesplot`</span> package by examining <span class="co">[</span><span class="ot">the vignette</span><span class="co">](https://mc-stan.org/bayesplot/articles/graphical-ppcs.html)</span>. Experiment with some different possibilities for these data.</span>
<span id="cb39-210"><a href="#cb39-210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-211"><a href="#cb39-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-212"><a href="#cb39-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-213"><a href="#cb39-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-214"><a href="#cb39-214" aria-hidden="true" tabindex="-1"></a>The posterior predictive distribution gives us a straightfoward way to test our model's performance: </span>
<span id="cb39-215"><a href="#cb39-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-216"><a href="#cb39-216" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>we use the model to generate fake observations. </span>
<span id="cb39-217"><a href="#cb39-217" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>plot these on top of the real data</span>
<span id="cb39-218"><a href="#cb39-218" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>if the data is a really poor match, we know our model has a distorted view of the world.</span>
<span id="cb39-219"><a href="#cb39-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-220"><a href="#cb39-220" aria-hidden="true" tabindex="-1"></a><span class="fu">## Different groups are different</span></span>
<span id="cb39-221"><a href="#cb39-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-222"><a href="#cb39-222" aria-hidden="true" tabindex="-1"></a>let's add in differences among species</span>
<span id="cb39-223"><a href="#cb39-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-226"><a href="#cb39-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-227"><a href="#cb39-227" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> </span>
<span id="cb39-228"><a href="#cb39-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bill_dep, <span class="at">fill =</span> species))<span class="sc">+</span> </span>
<span id="cb39-229"><a href="#cb39-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb39-230"><a href="#cb39-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>)</span>
<span id="cb39-231"><a href="#cb39-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-232"><a href="#cb39-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-233"><a href="#cb39-233" aria-hidden="true" tabindex="-1"></a>Now we can see that the distribution is probably three different distributions, all placed together. </span>
<span id="cb39-234"><a href="#cb39-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-235"><a href="#cb39-235" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb39-236"><a href="#cb39-236" aria-hidden="true" tabindex="-1"></a>Sometimes scientists will plot histograms of data at the beginning of a research project, and use the histogram to decide if their data are "normally distributed" or not. This is not helpful! Instead, decide on a model first, and ask yourself what kind of data you expect.</span>
<span id="cb39-237"><a href="#cb39-237" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-238"><a href="#cb39-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-239"><a href="#cb39-239" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding a discrete predictor variable.</span></span>
<span id="cb39-240"><a href="#cb39-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-241"><a href="#cb39-241" aria-hidden="true" tabindex="-1"></a>Here we extend the model to give each species a different average bill depth. </span>
<span id="cb39-242"><a href="#cb39-242" aria-hidden="true" tabindex="-1"></a>How many parameters are in this model?</span>
<span id="cb39-243"><a href="#cb39-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-244"><a href="#cb39-244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb39-245"><a href="#cb39-245" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb39-246"><a href="#cb39-246" aria-hidden="true" tabindex="-1"></a>\text{Bill depth}_{i} &amp;\sim \text{Normal}(\mu_{\text{species}<span class="co">[</span><span class="ot">i</span><span class="co">]</span>}, \sigma) <span class="sc">\\</span></span>
<span id="cb39-247"><a href="#cb39-247" aria-hidden="true" tabindex="-1"></a>\mu_{\text{species}} &amp;\sim \text{Normal}(17, 2) <span class="sc">\\</span></span>
<span id="cb39-248"><a href="#cb39-248" aria-hidden="true" tabindex="-1"></a>\sigma &amp;\sim \text{Exponential}(2) <span class="sc">\\</span></span>
<span id="cb39-249"><a href="#cb39-249" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb39-250"><a href="#cb39-250" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb39-251"><a href="#cb39-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-252"><a href="#cb39-252" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb39-253"><a href="#cb39-253" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick detour : vector indexing</span></span>
<span id="cb39-254"><a href="#cb39-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-255"><a href="#cb39-255" aria-hidden="true" tabindex="-1"></a>A **very** useful technique, in both R and Stan, is transforming a vector with _indexing_. </span>
<span id="cb39-256"><a href="#cb39-256" aria-hidden="true" tabindex="-1"></a>Vector indexing requires two vectors: the first contains values we want to select or replicate, the second contains integers giving the positions of the elements we want. For example:</span>
<span id="cb39-257"><a href="#cb39-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-260"><a href="#cb39-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-261"><a href="#cb39-261" aria-hidden="true" tabindex="-1"></a>some_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"taco"</span>, <span class="st">"cat"</span>, <span class="st">"goat"</span>, <span class="st">"cheeze"</span>, <span class="st">"pizza"</span>)</span>
<span id="cb39-262"><a href="#cb39-262" aria-hidden="true" tabindex="-1"></a>positions <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">5</span>)</span>
<span id="cb39-263"><a href="#cb39-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-264"><a href="#cb39-264" aria-hidden="true" tabindex="-1"></a>some_values[positions]</span>
<span id="cb39-265"><a href="#cb39-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-266"><a href="#cb39-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-267"><a href="#cb39-267" aria-hidden="true" tabindex="-1"></a>This works for number values as well, and is very useful when you want to do simulations! let's simulate three groups with different averages.</span>
<span id="cb39-268"><a href="#cb39-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-271"><a href="#cb39-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-272"><a href="#cb39-272" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb39-273"><a href="#cb39-273" aria-hidden="true" tabindex="-1"></a>some_means <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">17</span>, <span class="dv">19</span>)</span>
<span id="cb39-274"><a href="#cb39-274" aria-hidden="true" tabindex="-1"></a>some_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"taco"</span>, <span class="st">"cat"</span>, <span class="st">"goat"</span>)</span>
<span id="cb39-275"><a href="#cb39-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-276"><a href="#cb39-276" aria-hidden="true" tabindex="-1"></a>df_of_means <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">index =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="dv">42</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb39-277"><a href="#cb39-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">the_mean =</span> some_means[index],</span>
<span id="cb39-278"><a href="#cb39-278" aria-hidden="true" tabindex="-1"></a>         <span class="at">labels =</span> some_labels[index],</span>
<span id="cb39-279"><a href="#cb39-279" aria-hidden="true" tabindex="-1"></a>         <span class="at">obs =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(the_mean),</span>
<span id="cb39-280"><a href="#cb39-280" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mean =</span> the_mean,</span>
<span id="cb39-281"><a href="#cb39-281" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sd =</span> <span class="dv">1</span>))</span>
<span id="cb39-282"><a href="#cb39-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-283"><a href="#cb39-283" aria-hidden="true" tabindex="-1"></a>df_of_means <span class="sc">|&gt;</span> </span>
<span id="cb39-284"><a href="#cb39-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> obs, <span class="at">fill =</span> labels)) <span class="sc">+</span> </span>
<span id="cb39-285"><a href="#cb39-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span>
<span id="cb39-286"><a href="#cb39-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-287"><a href="#cb39-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-288"><a href="#cb39-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-289"><a href="#cb39-289" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vector indexing in Stan</span></span>
<span id="cb39-290"><a href="#cb39-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-291"><a href="#cb39-291" aria-hidden="true" tabindex="-1"></a>We can use this very same technique in Stan: </span>
<span id="cb39-292"><a href="#cb39-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-293"><a href="#cb39-293" aria-hidden="true" tabindex="-1"></a>The only difference to the previous model is in the line with the for-loop, which is now replaced with a vectorized expression. This is faster to write and will run faster in Stan. However it's not possible in every case.</span>
<span id="cb39-294"><a href="#cb39-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-295"><a href="#cb39-295" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb39-296"><a href="#cb39-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-297"><a href="#cb39-297" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sampling the species model</span></span>
<span id="cb39-298"><a href="#cb39-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-299"><a href="#cb39-299" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb39-300"><a href="#cb39-300" aria-hidden="true" tabindex="-1"></a><span class="fu">### EXERCISE</span></span>
<span id="cb39-301"><a href="#cb39-301" aria-hidden="true" tabindex="-1"></a>Fit one the species-specific model above using brms. TIP: set the formula to be <span class="in">`bill_dep ~ 0 + species`</span>. </span>
<span id="cb39-302"><a href="#cb39-302" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What changes do you need to make to the prior? </span>
<span id="cb39-303"><a href="#cb39-303" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Visualize the posterior with <span class="in">`bayesplot`</span>. Does it look better than the model without species? How can you tell?</span>
<span id="cb39-304"><a href="#cb39-304" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-305"><a href="#cb39-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-306"><a href="#cb39-306" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb39-307"><a href="#cb39-307" aria-hidden="true" tabindex="-1"></a><span class="fu">### SOLUTION</span></span>
<span id="cb39-308"><a href="#cb39-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-311"><a href="#cb39-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-312"><a href="#cb39-312" aria-hidden="true" tabindex="-1"></a><span class="do">## formula</span></span>
<span id="cb39-313"><a href="#cb39-313" aria-hidden="true" tabindex="-1"></a>bill_spp_bf <span class="ot">&lt;-</span> <span class="fu">bf</span>(bill_dep <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> species, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb39-314"><a href="#cb39-314" aria-hidden="true" tabindex="-1"></a><span class="do">## prior</span></span>
<span id="cb39-315"><a href="#cb39-315" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bill_spp_bf, <span class="at">data =</span> penguins_noNAbill)</span>
<span id="cb39-316"><a href="#cb39-316" aria-hidden="true" tabindex="-1"></a>bill_spp_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb39-317"><a href="#cb39-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">17</span>, <span class="dv">2</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb39-318"><a href="#cb39-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(.<span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">lb =</span> <span class="dv">0</span>)</span>
<span id="cb39-319"><a href="#cb39-319" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-320"><a href="#cb39-320" aria-hidden="true" tabindex="-1"></a>bill_spp_prior</span>
<span id="cb39-321"><a href="#cb39-321" aria-hidden="true" tabindex="-1"></a><span class="do">## fit</span></span>
<span id="cb39-322"><a href="#cb39-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-323"><a href="#cb39-323" aria-hidden="true" tabindex="-1"></a>bill_spp_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(bill_spp_bf, </span>
<span id="cb39-324"><a href="#cb39-324" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> penguins_noNAbill, </span>
<span id="cb39-325"><a href="#cb39-325" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior =</span> bill_spp_prior,</span>
<span id="cb39-326"><a href="#cb39-326" aria-hidden="true" tabindex="-1"></a>                <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb39-327"><a href="#cb39-327" aria-hidden="true" tabindex="-1"></a>                <span class="at">refresh =</span> <span class="dv">0</span>L,</span>
<span id="cb39-328"><a href="#cb39-328" aria-hidden="true" tabindex="-1"></a>                <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/discrete_predictor/bill_spp_brm.rds"</span>), </span>
<span id="cb39-329"><a href="#cb39-329" aria-hidden="true" tabindex="-1"></a>                <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span>
<span id="cb39-330"><a href="#cb39-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-331"><a href="#cb39-331" aria-hidden="true" tabindex="-1"></a>bill_spp_brm</span>
<span id="cb39-332"><a href="#cb39-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-333"><a href="#cb39-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-334"><a href="#cb39-334" aria-hidden="true" tabindex="-1"></a>and we can repeat the posterior checking from before:</span>
<span id="cb39-335"><a href="#cb39-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-338"><a href="#cb39-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-339"><a href="#cb39-339" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior predictive check</span></span>
<span id="cb39-340"><a href="#cb39-340" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bill_spp_brm, <span class="at">type =</span> <span class="st">"dens_overlay"</span>, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb39-341"><a href="#cb39-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-342"><a href="#cb39-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-343"><a href="#cb39-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-344"><a href="#cb39-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-345"><a href="#cb39-345" aria-hidden="true" tabindex="-1"></a>The predicted distribution is now much more like the real data!</span>
<span id="cb39-346"><a href="#cb39-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-347"><a href="#cb39-347" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-348"><a href="#cb39-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-349"><a href="#cb39-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-350"><a href="#cb39-350" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Further questions &amp; challenges</span></span>
<span id="cb39-351"><a href="#cb39-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-352"><a href="#cb39-352" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>This model assumes that the $\sigma$ parameter is the same for all three species. Can you relax that assumption?</span>
<span id="cb39-353"><a href="#cb39-353" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>I recommended that you remove the intercept from the model using <span class="in">`bill_dep ~ 0 + species`</span>. What changes if you put it back in? why?</span>
<span id="cb39-354"><a href="#cb39-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-355"><a href="#cb39-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-356"><a href="#cb39-356" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing species -- using `tidybayes`</span></span>
<span id="cb39-357"><a href="#cb39-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-358"><a href="#cb39-358" aria-hidden="true" tabindex="-1"></a>We can also make figures for each individual species. </span>
<span id="cb39-359"><a href="#cb39-359" aria-hidden="true" tabindex="-1"></a>Here we will move away from using <span class="in">`bayesplot`</span> and try to visualize our posterior using the handy functions in the <span class="co">[</span><span class="ot">`tidybayes` package</span><span class="co">](https://mjskay.github.io/tidybayes/)</span>.</span>
<span id="cb39-360"><a href="#cb39-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-363"><a href="#cb39-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-364"><a href="#cb39-364" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb39-365"><a href="#cb39-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-366"><a href="#cb39-366" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="sc">|&gt;</span> </span>
<span id="cb39-367"><a href="#cb39-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species) <span class="sc">|&gt;</span> </span>
<span id="cb39-368"><a href="#cb39-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb39-369"><a href="#cb39-369" aria-hidden="true" tabindex="-1"></a>  tidybayes<span class="sc">::</span><span class="fu">add_predicted_rvars</span>(bill_spp_brm, <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-370"><a href="#cb39-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> .prediction, <span class="at">y =</span> species, <span class="at">fill =</span> species)) <span class="sc">+</span> </span>
<span id="cb39-371"><a href="#cb39-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_slab</span>()</span>
<span id="cb39-372"><a href="#cb39-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-373"><a href="#cb39-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-374"><a href="#cb39-374" aria-hidden="true" tabindex="-1"></a>We can visualize the uncertainty in predicted values AND in group means :</span>
<span id="cb39-375"><a href="#cb39-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-378"><a href="#cb39-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb39-379"><a href="#cb39-379" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> penguins_noNAbill <span class="sc">%&gt;%</span></span>
<span id="cb39-380"><a href="#cb39-380" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">data_grid</span>(species)</span>
<span id="cb39-381"><a href="#cb39-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-382"><a href="#cb39-382" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb39-383"><a href="#cb39-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_epred_draws</span>(bill_spp_brm)</span>
<span id="cb39-384"><a href="#cb39-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-385"><a href="#cb39-385" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span>  grid <span class="sc">%&gt;%</span></span>
<span id="cb39-386"><a href="#cb39-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_predicted_draws</span>(bill_spp_brm)</span>
<span id="cb39-387"><a href="#cb39-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-388"><a href="#cb39-388" aria-hidden="true" tabindex="-1"></a>penguins_noNAbill <span class="sc">%&gt;%</span></span>
<span id="cb39-389"><a href="#cb39-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> species, <span class="at">x =</span> bill_dep)) <span class="sc">+</span></span>
<span id="cb39-390"><a href="#cb39-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_interval</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction), <span class="at">data =</span> preds) <span class="sc">+</span></span>
<span id="cb39-391"><a href="#cb39-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="fu">aes</span>(<span class="at">x =</span> .epred), <span class="at">data =</span> means, <span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">66</span>, .<span class="dv">95</span>), <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">y =</span> <span class="sc">-</span><span class="fl">0.3</span>)) <span class="sc">+</span></span>
<span id="cb39-392"><a href="#cb39-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">height =</span> .<span class="dv">05</span>, <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb39-393"><a href="#cb39-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>() <span class="sc">+</span> </span>
<span id="cb39-394"><a href="#cb39-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dark</span>()</span>
<span id="cb39-395"><a href="#cb39-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-396"><a href="#cb39-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-397"><a href="#cb39-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-398"><a href="#cb39-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-399"><a href="#cb39-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercises</span></span>
<span id="cb39-400"><a href="#cb39-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-401"><a href="#cb39-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-402"><a href="#cb39-402" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 1</span></span>
<span id="cb39-403"><a href="#cb39-403" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>repeat this activity for another variable in the dataset. Does the same code work on bill length? What about body size? What would you change about the model (if anything)</span>
<span id="cb39-404"><a href="#cb39-404" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>use bayesplot to examine the fit of body size to these data. </span>
<span id="cb39-405"><a href="#cb39-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-406"><a href="#cb39-406" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 2</span></span>
<span id="cb39-407"><a href="#cb39-407" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>generate some random groups of your own, with known means. How well does the model fit these data</span>
<span id="cb39-408"><a href="#cb39-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-409"><a href="#cb39-409" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 3</span></span>
<span id="cb39-410"><a href="#cb39-410" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>As you can see, the model assumes the same sigma for all species. what if you relax this? </span>
<span id="cb39-411"><a href="#cb39-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-412"><a href="#cb39-412" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optional! </span></span>
<span id="cb39-413"><a href="#cb39-413" aria-hidden="true" tabindex="-1"></a>Try this on your own data! </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>