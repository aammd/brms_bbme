<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="simulating, checking and understanding a simple model.">

<title>Introduction to brms and Bayesian workflow – Generalized Linear Hierarchical models in brms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-83ef79ec45755748b848d52875005fa0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Generalized Linear Hierarchical models in brms</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
    <a href="https://github.com/bios2/hiermod" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-process" id="toc-the-process" class="nav-link active" data-scroll-target="#the-process">The process</a></li>
  <li><a href="#simulation-in-r" id="toc-simulation-in-r" class="nav-link" data-scroll-target="#simulation-in-r">Simulation in R</a></li>
  <li><a href="#simple-exercise-in-simulation" id="toc-simple-exercise-in-simulation" class="nav-link" data-scroll-target="#simple-exercise-in-simulation">Simple exercise in simulation</a>
  <ul class="collapse">
  <li><a href="#some-questions-to-ask-about-simulated-data" id="toc-some-questions-to-ask-about-simulated-data" class="nav-link" data-scroll-target="#some-questions-to-ask-about-simulated-data">Some questions to ask about simulated data</a></li>
  </ul></li>
  <li><a href="#simulating-data-in-brms" id="toc-simulating-data-in-brms" class="nav-link" data-scroll-target="#simulating-data-in-brms">Simulating data in brms</a>
  <ul class="collapse">
  <li><a href="#the-model-formula" id="toc-the-model-formula" class="nav-link" data-scroll-target="#the-model-formula">The model formula</a></li>
  <li><a href="#the-prior" id="toc-the-prior" class="nav-link" data-scroll-target="#the-prior">The prior</a></li>
  <li><a href="#sampling-a-prior-in-brms" id="toc-sampling-a-prior-in-brms" class="nav-link" data-scroll-target="#sampling-a-prior-in-brms">Sampling a prior in <code>brms</code></a></li>
  </ul></li>
  <li><a href="#parameter-recovery" id="toc-parameter-recovery" class="nav-link" data-scroll-target="#parameter-recovery">Parameter recovery</a></li>
  <li><a href="#parameter-recovery-in-brms-sampling-the-posterior" id="toc-parameter-recovery-in-brms-sampling-the-posterior" class="nav-link" data-scroll-target="#parameter-recovery-in-brms-sampling-the-posterior">Parameter recovery in brms – sampling the posterior</a>
  <ul class="collapse">
  <li><a href="#bayesplot" id="toc-bayesplot" class="nav-link" data-scroll-target="#bayesplot">bayesplot</a></li>
  <li><a href="#shinystan" id="toc-shinystan" class="nav-link" data-scroll-target="#shinystan">Shinystan</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Introduction to brms and Bayesian workflow</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>

<div>
  <div class="description">
    <p>simulating, checking and understanding a simple model.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="st">"auto_write"</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Goals of this lesson
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Introduce the idea of a generative model</li>
<li>Using generated data to validate a model</li>
<li>Stan model syntax</li>
<li>Outline of a Bayesian workflow</li>
</ol>
</div>
</div>
<section id="the-process" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-process">The process</h3>
<p>To practice our first model, we’ll being with an imaginary example. We’ll imagine we’re conducting a particularly pleasant study: counting birds!</p>
<p><strong>Question</strong> How many birds will each person in the class find? For the purposes of this example, let’s say there are 22 people.</p>
<ol type="1">
<li>We’re going to count birds, so we’ll have count data: a number that is either 0 or some positive, round number</li>
<li>We’ll make a simplifying assumption: everybody has the same chance of seeing a bird (i.e.&nbsp;no differences in skill or equipment), and everyone in the class is an independent observer (i.e.&nbsp;nobody is working in pairs, etc.)</li>
<li>Everyone in the class makes only one count, so we have 22 numbers.</li>
</ol>
<p>We’re Bayesian, so we need to write a probability distribution for all the possible values.</p>
<p><span class="math display">\[
\begin{align}
\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) \\
\lambda &amp;\sim \text{Uniform}(0, 60)
\end{align}
\]</span></p>
<p>A quick note about notation for models like these:</p>
<ul>
<li>We use a subscript <span class="math inline">\(i\)</span> to indicate the “label” for each observation in our dataset. You can think of this as the row number of the data spreadsheet, and imagine sliding your finger down the column of measurements, modelling each value in turn.</li>
<li>Usually we’ll use more general language, such as <span class="math inline">\(y_i\)</span>. But for this simple example I wanted to make things as explicit as possible.</li>
<li>Notice the symbol <span class="math inline">\(\sim\)</span>. This is read as “distributed as”, and indicates the probability distribution from which the values might come. When the values we’re talking about are data that we can observe (in this case, counts of birds), we call the distribution the likelihood. When the value is something we can’t observe (in this case, the average count <span class="math inline">\(\lambda\)</span>) we call the distribution the prior.</li>
</ul>
<aside>
Remember that measuring uncertainty with probability is what makes thinking Bayesian. That means we need a probability distribution for everything we can’t observe (like an average) or haven’t seen yet (like observations)
</aside>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’ll be talking about better ways to model count data in a later exercise! For now, I’m using the Uniform distribution for simplicity. It’s not usually a very good choice!</p>
</div>
</div>
</section>
<section id="simulation-in-r" class="level3">
<h3 class="anchored" data-anchor-id="simulation-in-r">Simulation in R</h3>
<p>Before starting work on real data, we are going to begin by learning how to generate data by simulation. There are at least three reasons why this is a good idea:</p>
<ol type="1">
<li><strong>Understand your priors.</strong>. For most interesting models in ecology, you will not be able to pick good numbers for your prior parameters just by thinking hard. Should the prior on annual tree growth be <span class="math inline">\(\text{Normal}(2, 1)\)</span> ? Or should the standard deviation be bigger? Smaller? As we’ll see, simulation will demystify the process.</li>
<li><strong>Validate your model.</strong> Bayesian models are great because they can create datasets by simulation. This suggests a very minimum requirement we might have for a statistical model: use known parameters and a model to generate data, then fit that same model to the very data it generated, and see if we get back something close to those known parameter values.</li>
<li><strong>Test your understanding.</strong> Perhaps most importantly, simulation helps you to test your own intuition. If you can simulate data from your model, then you really understand it! If you can’t, then you don’t know quite how it works yet. It’s rare<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> that a biologist will fail to learn something by simulating a dataset.</li>
</ol>
</section>
<section id="simple-exercise-in-simulation" class="level2">
<h2 class="anchored" data-anchor-id="simple-exercise-in-simulation">Simple exercise in simulation</h2>
<p>Let’s imagine we are taking a walk as a group today at this beautiful field site. What is the number of birds (total abundance of ALL species) each of us is going to see on our hike?</p>
<section id="some-questions-to-ask-about-simulated-data" class="level3">
<h3 class="anchored" data-anchor-id="some-questions-to-ask-about-simulated-data">Some questions to ask about simulated data</h3>
<ol type="1">
<li>What kind of observations are you going to make? Do they have a minimum or maximum value? Are they integers, or are they decimal numbers, or something else?</li>
<li>Where do the numbers come from? This could be anything, from simple linear approximations (i.e.&nbsp;the models we’re looking at in this course) to ODEs, mathematical models, GAMs, etc.</li>
<li>How many observations will we be making?</li>
</ol>
<p>One of the most useful traits of Bayesian models is that they are <em>generative</em>: they can be used to make a simulated dataset. We’ll do that now for our bird example.</p>
<p>let’s simulate from a Poisson distribution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_people <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>avg_birds_per_person <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">30</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>bird_count <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n_people, <span class="at">lambda =</span> avg_birds_per_person)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some things to note in the code above:</p>
<p>Every statistical distribution that is in R (which is a lot! almost all! ) has four different functions. If the distribution is called <code>dist</code>, then they are:</p>
<ul>
<li><code>rdist</code> = draw random numbers from <code>dist</code></li>
<li><code>qdist</code> = the quantile function – what value gives a certain proportion of the distribution?</li>
<li><code>pdist</code> = the probability density function – what proportion of the distribution is below a certain value?</li>
<li><code>ddist</code> the density function = draws the “shape” of a distribution. How probable are specific values?</li>
</ul>
<p>The other thing to note is that there are TWO simulation steps here: <strong>first</strong>, simulating a value of the average (<span class="math inline">\(\lambda\)</span>) and <strong>second</strong>, simulating observations. In our model, the Uniform distribution was referred to as the <em>prior</em>, and the Poisson distribution was referred to as a <em>likelihood</em>, but here you can see that they are very nearly the same thing: just statements about what distribution of values might be most consistent with the data.</p>
<section id="plotting-the-result" class="level4">
<h4 class="anchored" data-anchor-id="plotting-the-result">Plotting the result</h4>
<p>Let’s take a look at our simulated values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bird_count, <span class="at">col =</span> <span class="st">"lightblue"</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Histogram of simulated counts of birds</figcaption>
</figure>
</div>
</div>
</div>
<p>This is pretty great, and represents one possible realization of sampling. However, one sample isn’t enough to tell us about what our <span class="math inline">\(\text{Uniform}(0, 60)\)</span> prior really means.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EXERCISE
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try to make many different simulations (say, 12 simulations). This represents 12 different repeats of the whole process: draw a value from the uniform prior, THEN draw a value from the poisson. Visualize them any way you want! (the worked example below uses <code>ggplot2</code>)</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
SOLUTION
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>simulate_some_birds <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">60</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">birds_seen =</span> <span class="fu">rpois</span>(<span class="dv">23</span>, <span class="at">lambda =</span> lambda),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">lambda =</span> lambda)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>bird_simulations <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="cf">function</span>(x) <span class="fu">simulate_some_birds</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"simulation_id"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>bird_simulations <span class="sc">|&gt;</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> birds_seen)) <span class="sc">+</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">28</span>) <span class="sc">+</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation_id) <span class="sc">+</span> </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Number of birds observed per person"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Twelve different simulations of a possible bird dataset. Do all of these seem plausible?</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>This figure shows different simulations of what, according to our prior, might be reasonable datasets for us to study. Do any of them seem implausible to you? If so, try changing the prior. The goal is to make fake datasets that <em>seem</em> plausible, but which still include the possibility of some surprising observations.</p>
<p>When you have a prior that generates observations that cover a range of scientifically reasonable values, then you are ready to move on to fitting real data.</p>
<p>However before we actually do that, let’s do the whole thing again: this time using brms</p>
</section>
</section>
</section>
<section id="simulating-data-in-brms" class="level2">
<h2 class="anchored" data-anchor-id="simulating-data-in-brms">Simulating data in brms</h2>
<p>Let’s look back at the equation:</p>
<p><span class="math display">\[
\begin{align}
\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) \\
\lambda &amp;\sim \text{Uniform}(0, 60)
\end{align}
\]</span></p>
<p>And then translate it into brms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rcpp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading 'brms' package (version 2.23.0). Useful instructions
can be found by typing help('brms'). A more detailed introduction
to the package is available through vignette('brms_overview').</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'brms'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:rstan':

    loo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    ar</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bird_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(birds_seen <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"identity"</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>bird_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">person_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">birds_seen =</span> <span class="dv">0</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bird_formula, <span class="at">data =</span> bird_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intercept ~ student_t(3, 0, 2.5)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>bird_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">60</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">ub =</span> <span class="dv">60</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>bird_model <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> bird_formula,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> bird_data,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior =</span> bird_prior, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sample_prior =</span> <span class="st">"only"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/01_simulation/bird_model.rds"</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you sample the model, as we’ll do later, Stan samples the posterior distribution using Hamiltonian Monte Carlo.</p>
<p>Before we run it, let’s look at the parts of the code above:</p>
<section id="the-model-formula" class="level3">
<h3 class="anchored" data-anchor-id="the-model-formula">The model formula</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bird_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(birds_seen <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The model formula is an extension of the kind of syntax used in <code>lme4</code>. We can also specify the response distribution here, via the <code>family</code> arguement.</p>
</section>
<section id="the-prior" class="level3">
<h3 class="anchored" data-anchor-id="the-prior">The prior</h3>
<p>The prior is specified as a vector of special objects, created by the <code>prior</code> function. Note that the first argument to these functions is not R, but in fact actually a bit of Stan code.</p>
<p>When I work, I almost always use this pair of steps:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bird_formula, <span class="at">data =</span> bird_data)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>bird_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">60</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">ub =</span> <span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first step uses the formula and the dataset to print out a table of all the parameters in the model, and their default priors. I use this table as a reference during the second step, where I define my own priors for my model.</p>
<p>Always do these two steps!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why does <code>get_prior</code> require the dataset?
</div>
</div>
<div class="callout-body-container callout-body">
<p>In Bayesian statistics, quantites are either unobserved or observed. Anything observed is called “data”, and anything unobserved is called a “parameter”. The design of <code>brms</code> tries to be very general and flexible; it looks for the names of objects from the formula in the dataset to see if they are observed quantities or parameters.</p>
</div>
</div>
</section>
<section id="sampling-a-prior-in-brms" class="level3">
<h3 class="anchored" data-anchor-id="sampling-a-prior-in-brms">Sampling a prior in <code>brms</code></h3>
<p>When we run <code>brm(bird_formula, data = bird_data, prior = bird_prior, sample_prior = "only")</code>, we sample only from the prior. This generates a large number of simulated datasets – the default is 4000! Each time the model samples, it draws a new value for the unobserved average (<code>avg_birds_per_person</code>) and then 22 values for the number of birds seen by each person.</p>
<p>Let’s pull out just a few of these datasets and visualize them.</p>
<p>We’ll use a wonderful package called <a href="http://mjskay.github.io/tidybayes/"><code>tidybayes</code></a> to easily extract posterior draws from <code>stanfit</code> objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tidybayes'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:brms':

    dstudent_t, pstudent_t, qstudent_t, rstudent_t</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tidybayes<span class="sc">::</span><span class="fu">get_variables</span>(bird_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_Intercept"   "Intercept"     "lprior"        "lp__"         
 [5] "accept_stat__" "stepsize__"    "treedepth__"   "n_leapfrog__" 
 [9] "divergent__"   "energy__"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>birds_intercepts <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(bird_model, Intercept,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># ndraws = 20,</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">seed =</span> <span class="dv">525600</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(birds_intercepts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(birds_intercepts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  .chain .iteration .draw Intercept
   &lt;int&gt;      &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;
1      1          1     1     38.9 
2      1          2     2     40.2 
3      1          3     3     40.0 
4      1          4     4     35.0 
5      1          5     5      9.84
6      1          6     6     35.7 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">add_predicted_draws</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  bird_data, </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  bird_model)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.draw <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">|&gt;</span>   </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction)) <span class="sc">+</span> </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dotplot</span>() <span class="sc">+</span> </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.draw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Bin width defaults to 1/30 of the range of the data. Pick better value with
`binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Prior simulations of bird observations</figcaption>
</figure>
</div>
</div>
</div>
<p>Here we pass <code>tidybayes::spread_draws()</code> the model name, as well as the names of the parameters that we want to work with. The handy function <code>tidyverse::get_variables</code> is a key part of this workflow.</p>
<p>Let’s see what we get from tidybayes by looking at the first few rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">9</span>) <span class="sc">|&gt;</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">person_id</th>
<th style="text-align: right;">birds_seen</th>
<th style="text-align: right;">.row</th>
<th style="text-align: right;">.chain</th>
<th style="text-align: right;">.iteration</th>
<th style="text-align: right;">.draw</th>
<th style="text-align: right;">.prediction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">41</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">34</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">34</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">38</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">43</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">32</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">46</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Remember we asked for only 25 of the 4000 posterior samples. Here is one sample, and just a bit of the next.</p>
<!-- We can see that the value of `avg_birds_per_person` is the same within each iteration. The model uses this average to sample every `bird_count` value, one for each person making observations. Then the program takes a new value of `avg_birds_per_person` and simulates everyone's `bird_count` again! -->
<p>Let’s take a look at some of these simulations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.draw <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">16</span>))  <span class="sc">|&gt;</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(birds_intercepts, <span class="at">by =</span> <span class="fu">join_by</span>(.draw)) <span class="sc">|&gt;</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction)) <span class="sc">+</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> Intercept),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.draw) <span class="sc">+</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Prior simulations of bird counts. Green bars are the mean for a particular simulation, and orange histograms show the distribution of observations around this mean.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="parameter-recovery" class="level2">
<h2 class="anchored" data-anchor-id="parameter-recovery">Parameter recovery</h2>
<p>Let’s go back and look at the fake datasets we created in R</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>avg_birds_per_person</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17.12789</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>bird_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 23 10 19 27 20 15 16 18 18 22 14 14 14 18 17 13 26 19 16 13 10</code></pre>
</div>
</div>
<p>and let’s see if we can recapture the only known parameter, <code>avg_birds_per_person</code>, which is equal to 17.127887.</p>
<p>We’ll do it first in R, using the function <code>fitdistr</code> from the <code>MASS</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>MASS<span class="sc">::</span><span class="fu">fitdistr</span>(bird_count, dpois, <span class="at">start =</span> <span class="fu">list</span>(<span class="at">lambda=</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in stats::optim(x = c(23L, 10L, 19L, 27L, 20L, 15L, 16L, 18L, 18L, : one-dimensional optimization by Nelder-Mead is unreliable:
use "Brent" or optimize() directly</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     lambda  
  17.2382812 
 ( 0.9060239)</code></pre>
</div>
</div>
<p>This could also be done with <code>glm</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>bird_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(bird_count <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">"poisson"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(bird_glm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
    17.2381 </code></pre>
</div>
</div>
<p>You can see that in all cases we are getting close to the value of <code>avg_birds_per_person</code>, which in these simulations is the true value.</p>
</section>
<section id="parameter-recovery-in-brms-sampling-the-posterior" class="level2">
<h2 class="anchored" data-anchor-id="parameter-recovery-in-brms-sampling-the-posterior">Parameter recovery in brms – sampling the posterior</h2>
<p>Time for the <a href="slides/03_Stan">HMC Slides!</a></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EXERCISE: parameter recovery in Stan
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the Stan code above to fit the model to our simulated data. Do we recover the parameters? That is, rerun the example above but change the <code>sample_prior</code> argument to “yes”</p>
<p>Select one of our simulations to be the dataset for this analysis</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>one_bird_simulation <span class="ot">&lt;-</span> bird_simulations <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select one simulation, could be any one</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(simulation_id <span class="sc">==</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
SOLUTION
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>the <code>brms</code> syntax is only slightly changed! note the different filename and the different object name as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>bird_posterior <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> bird_formula,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> one_bird_simulation,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior =</span> bird_prior, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/01_simulation/bird_posterior.rds"</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">file_refit =</span> <span class="st">"on_change"</span>, <span class="at">refresh =</span><span class="dv">0</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bird_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: poisson 
  Links: mu = identity 
Formula: birds_seen ~ 1 
   Data: one_bird_simulation (Number of observations: 23) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    11.53      0.69    10.22    12.90 1.00     1358     2423

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>We can look at a table of coefficients but it is much easier to once again look at posterior samples as a figure.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualize everything!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Bayesian workflows are highly visual. Make as many plots as you can: of your parameters, your predictions, the performance of your chains, etc.</p>
</div>
</div>
<section id="bayesplot" class="level3">
<h3 class="anchored" data-anchor-id="bayesplot">bayesplot</h3>
<p>Another essential package for working with posterior samples is called <a href="http://mc-stan.org/bayesplot/"><code>bayesplot</code></a>. Let’s use it to compare the posterior and prior distribution for the intercept.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tidybayes<span class="sc">::</span><span class="fu">get_variables</span>(bird_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_Intercept"     "Intercept"       "prior_Intercept" "lprior"         
 [5] "lp__"            "accept_stat__"   "stepsize__"      "treedepth__"    
 [9] "n_leapfrog__"    "divergent__"     "energy__"       </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_areas</span>(bird_posterior, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"prior_Intercept"</span>)) <span class="sc">+</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">unique</span>(one_bird_simulation<span class="sc">$</span>lambda), <span class="at">col =</span> <span class="st">"orange"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>posterior distribution for <code>avg_birds_per_person</code>. The orange line is the true parameter value, which we simulated in R.</figcaption>
</figure>
</div>
</div>
</div>
<section id="posterior-predictive-checks" class="level4">
<h4 class="anchored" data-anchor-id="posterior-predictive-checks">Posterior predictive checks</h4>
<p>Bayesian models MAKE data, which suggests a clear way to validate our models: ask the model to make some data, then see how well these data correspond to biology (e.g.&nbsp;to our real data). Here, we will take 50 fake datasets of bird counts and compare them to the simulation we first did in R.</p>
<p>The process involves a bit of fiddling around in R to get the simulated data, but then <code>bayesplot</code> does all the work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bird_posterior, <span class="at">type =</span> <span class="st">"dens_overlay"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="shinystan" class="level3">
<h3 class="anchored" data-anchor-id="shinystan">Shinystan</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>shinystan<span class="sc">::</span><span class="fu">launch_shinystan</span>(bird_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="level-1" class="level4">
<h4 class="anchored" data-anchor-id="level-1">Level 1</h4>
<ul>
<li>What would you do next to add complexity the bird-counting model above?</li>
<li>We plotted histograms to evaluate our model. Experiment with other types of plots. For example, what is the maximum value in each posterior simulation? What is the minimum? How to these compare to the real data? TIP: check out <code>?ppc_stat.</code></li>
</ul>
</section>
<section id="level-2" class="level4">
<h4 class="anchored" data-anchor-id="level-2">Level 2</h4>
<ul>
<li>Take a closer look at <code>poisson_model_samp$summary()</code>. All the values of <code>bird_count</code> are the same. That’s correct, but why?</li>
<li>Try to fit YOUR data and your chosen distribution from <a href="topics/00_distributions">Monday’s exercise</a>. Check to see if the distribution you chose is implemented in Stan – see, for example, <a href="https://mc-stan.org/docs/functions-reference/binary_distributions.html">this list</a>.</li>
<li>check the fit using the plots we have already seen today.</li>
</ul>
</section>
<section id="level-3" class="level4">
<h4 class="anchored" data-anchor-id="level-3">Level 3</h4>
<ul>
<li>You would never actually do the analysis in this exercise! If all you want is the average of a Poisson distribution, you can get that without any sampling at all. Start by writing the model with a different prior:</li>
</ul>
<p><span class="math display">\[
\begin{align}
\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) \\
\lambda &amp;\sim \text{Gamma}(9, .5)
\end{align}
\]</span></p>
<p>This lets us calculate the posterior distribution directly. See the equation <a href="https://en.wikipedia.org/wiki/Poisson_distribution#Bayesian_inference">on Wikipedia</a> and calculate the posterior for our bird data.</p>


<!-- -->

</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>in Andrew’s experience anyway!<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb48" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Introduction to brms and Bayesian workflow"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> |</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">  simulating, checking and understanding a simple model.</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: true</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="an">comments:</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">  hypothesis: false</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="st">"auto_write"</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## Goals of this lesson</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Introduce the idea of a generative model</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Using generated data to validate a model</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Stan model syntax</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Outline of a Bayesian workflow</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="fu">### The process</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>To practice our first model, we'll being with an imaginary example. We'll imagine we're conducting a particularly pleasant study: counting birds! </span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>**Question** How many birds will each person in the class find? For the purposes of this example, let's say there are 22 people.</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>We're going to count birds, so we'll have count data: a number that is either 0 or some positive, round number</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>We'll make a simplifying assumption: everybody has the same chance of seeing a bird (i.e. no differences in skill or equipment), and everyone in the class is an independent observer (i.e. nobody is working in pairs, etc.) </span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Everyone in the class makes only one count, so we have 22 numbers.</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>We're Bayesian, so we need to write a probability distribution for all the possible values.</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) <span class="sc">\\</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>\lambda &amp;\sim \text{Uniform}(0, 60)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>A quick note about notation for models like these:</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>We use a subscript $i$ to indicate the "label" for each observation in our dataset. You can think of this as the row number of the data spreadsheet, and imagine sliding your finger down the column of measurements, modelling each value in turn.</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Usually we'll use more general language, such as $y_i$. But for this simple example I wanted to make things as explicit as possible. </span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Notice the symbol $\sim$. This is read as "distributed as", and indicates the probability distribution from which the values might come.  When the values we're talking about are data that we can observe (in this case, counts of birds), we call the distribution the likelihood. When the value is something we can't observe (in this case, the average count $\lambda$) we call the distribution the prior. </span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">aside</span><span class="dt">&gt;</span>Remember that measuring uncertainty with probability is what makes thinking Bayesian. That means we need a probability distribution for everything we can't observe (like an average) or haven't seen yet (like observations)<span class="dt">&lt;/</span><span class="kw">aside</span><span class="dt">&gt;</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>We'll be talking about better ways to model count data in a later exercise! For now, I'm using the Uniform distribution for simplicity. It's not usually a very good choice! </span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulation in R</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>Before starting work on real data, we are going to begin by learning how to generate data by simulation.</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>There are at least three reasons why this is a good idea:</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Understand your priors.**. For most interesting models in ecology, you will not be able to pick good numbers for your prior parameters just by thinking hard. Should the prior on annual tree growth be $\text{Normal}(2, 1)$ ? Or should the standard deviation be bigger? Smaller? As we'll see, simulation will demystify the process. </span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Validate your model.** Bayesian models are great because they can create datasets by simulation. This suggests a very minimum requirement we might have for a statistical model: use known parameters and a model to generate data, then fit that same model to the very data it generated, and see if we get back something close to those known parameter values.</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Test your understanding.** Perhaps most importantly, simulation helps you to test your own intuition.  If you can simulate data from your model, then you really understand it!</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>If you can't, then you don't know quite how it works yet. It's rare^<span class="co">[</span><span class="ot">in Andrew's experience anyway!</span><span class="co">]</span> that a biologist will fail to learn something by simulating a dataset.</span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simple exercise in simulation</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>Let's imagine we are taking a walk as a group today at this beautiful field site. What is the number of birds (total abundance of ALL species) each of us is going to see on our hike?</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a><span class="fu">### Some questions to ask about simulated data</span></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>What kind of observations are you going to make? Do they have a minimum or maximum value?</span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>Are they integers, or are they decimal numbers, or something else?</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Where do the numbers come from? This could be anything, from simple linear approximations (i.e. the models we're looking at in this course) to ODEs, mathematical models, GAMs, etc. </span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>How many observations will we be making?</span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>One of the most useful traits of Bayesian models is that they are _generative_: they can be used to make a simulated dataset. </span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>We'll do that now for our bird example.</span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>let's simulate from a Poisson distribution:</span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, collapse=TRUE}</span></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>n_people <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>avg_birds_per_person <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">30</span>)</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>bird_count <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n_people, <span class="at">lambda =</span> avg_birds_per_person)</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>Some things to note in the code above: </span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>Every statistical distribution that is in R (which is a lot! almost all! ) has four different functions. </span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>If the distribution is called <span class="in">`dist`</span>, then they are:</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`rdist`</span> = draw random numbers from <span class="in">`dist`</span> </span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`qdist`</span> = the quantile function -- what value gives a certain proportion of the distribution?</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`pdist`</span> = the probability density function -- what proportion of the distribution is below a certain value?</span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`ddist`</span> the density function = draws the "shape" of a distribution. How probable are specific values?</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>The other thing to note is that there are TWO simulation steps here: **first**, simulating a value of the average ($\lambda$) and **second**, simulating observations. </span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>In our model, the Uniform distribution was referred to as the _prior_, and the Poisson distribution was referred to as a _likelihood_, but here you can see that they are very nearly the same thing: just statements about what distribution of values might be most consistent with the data.</span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Plotting the result</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>Let's take a look at our simulated values:</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Histogram of simulated counts of birds</span></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bird_count, <span class="at">col =</span> <span class="st">"lightblue"</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>))</span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>This is pretty great, and represents one possible realization of sampling. </span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a>However, one sample isn't enough to tell us about what our $\text{Uniform}(0, 60)$ prior really means. </span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a><span class="fu">### EXERCISE</span></span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a>Try to make many different simulations (say, 12 simulations). This represents 12 different repeats of the whole process: draw a value from the uniform prior, THEN draw a value from the poisson. Visualize them any way you want! (the worked example below uses <span class="in">`ggplot2`</span>)</span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a><span class="fu">### SOLUTION</span></span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Twelve different simulations of a possible bird dataset. Do all of these seem plausible? </span></span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">525600</span>)</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>simulate_some_birds <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">60</span>)</span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">birds_seen =</span> <span class="fu">rpois</span>(<span class="dv">23</span>, <span class="at">lambda =</span> lambda),</span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a>         <span class="at">lambda =</span> lambda)</span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>bird_simulations <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="cf">function</span>(x) <span class="fu">simulate_some_birds</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"simulation_id"</span>)</span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a>bird_simulations <span class="sc">|&gt;</span> </span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> birds_seen)) <span class="sc">+</span> </span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">28</span>) <span class="sc">+</span> </span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation_id) <span class="sc">+</span> </span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Number of birds observed per person"</span>)</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-153"><a href="#cb48-153" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a>This figure shows different simulations of what, according to our prior, might be reasonable datasets for us to study. Do any of them seem implausible to you? If so, try changing the prior. The goal is to make fake datasets that _seem_ plausible, but which still include the possibility of some surprising observations. </span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a>When you have a prior that generates observations that cover a range of scientifically reasonable values, then you are ready to move on to fitting real data.</span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a>However before we actually do that, let's do the whole thing again: this time using brms</span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulating data in brms</span></span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>Let's look back at the equation:</span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a>\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) <span class="sc">\\</span></span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a>\lambda &amp;\sim \text{Uniform}(0, 60)</span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-172"><a href="#cb48-172" aria-hidden="true" tabindex="-1"></a>And then translate it into brms:</span>
<span id="cb48-173"><a href="#cb48-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-174"><a href="#cb48-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-177"><a href="#cb48-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-178"><a href="#cb48-178" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb48-179"><a href="#cb48-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-180"><a href="#cb48-180" aria-hidden="true" tabindex="-1"></a>bird_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(birds_seen <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"identity"</span>))</span>
<span id="cb48-181"><a href="#cb48-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-182"><a href="#cb48-182" aria-hidden="true" tabindex="-1"></a>bird_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb48-183"><a href="#cb48-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">person_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>, </span>
<span id="cb48-184"><a href="#cb48-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">birds_seen =</span> <span class="dv">0</span>)</span>
<span id="cb48-185"><a href="#cb48-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-186"><a href="#cb48-186" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bird_formula, <span class="at">data =</span> bird_data)</span>
<span id="cb48-187"><a href="#cb48-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-188"><a href="#cb48-188" aria-hidden="true" tabindex="-1"></a>bird_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">60</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">ub =</span> <span class="dv">60</span>))</span>
<span id="cb48-189"><a href="#cb48-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-190"><a href="#cb48-190" aria-hidden="true" tabindex="-1"></a>bird_model <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> bird_formula,</span>
<span id="cb48-191"><a href="#cb48-191" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> bird_data,</span>
<span id="cb48-192"><a href="#cb48-192" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior =</span> bird_prior, </span>
<span id="cb48-193"><a href="#cb48-193" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sample_prior =</span> <span class="st">"only"</span>,</span>
<span id="cb48-194"><a href="#cb48-194" aria-hidden="true" tabindex="-1"></a>                  <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/01_simulation/bird_model.rds"</span>),</span>
<span id="cb48-195"><a href="#cb48-195" aria-hidden="true" tabindex="-1"></a>                  <span class="at">file_refit =</span> <span class="st">"on_change"</span>)</span>
<span id="cb48-196"><a href="#cb48-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-197"><a href="#cb48-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-198"><a href="#cb48-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-199"><a href="#cb48-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-200"><a href="#cb48-200" aria-hidden="true" tabindex="-1"></a>When you sample the model, as we'll do later, Stan samples the posterior distribution using Hamiltonian Monte Carlo.</span>
<span id="cb48-201"><a href="#cb48-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-202"><a href="#cb48-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-203"><a href="#cb48-203" aria-hidden="true" tabindex="-1"></a>Before we run it, let's look at the parts of the code above:</span>
<span id="cb48-204"><a href="#cb48-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-205"><a href="#cb48-205" aria-hidden="true" tabindex="-1"></a><span class="fu">### The model formula</span></span>
<span id="cb48-206"><a href="#cb48-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-207"><a href="#cb48-207" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb48-208"><a href="#cb48-208" aria-hidden="true" tabindex="-1"></a>bird_formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(birds_seen <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">poisson</span>())</span>
<span id="cb48-209"><a href="#cb48-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-210"><a href="#cb48-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-211"><a href="#cb48-211" aria-hidden="true" tabindex="-1"></a>The model formula is an extension of the kind of syntax used in <span class="in">`lme4`</span>. We can also specify the response distribution here, via the <span class="in">`family`</span> arguement. </span>
<span id="cb48-212"><a href="#cb48-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-213"><a href="#cb48-213" aria-hidden="true" tabindex="-1"></a><span class="fu">### The prior</span></span>
<span id="cb48-214"><a href="#cb48-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-215"><a href="#cb48-215" aria-hidden="true" tabindex="-1"></a>The prior is specified as a vector of special objects, created by the <span class="in">`prior`</span> function. Note that the first argument to these functions is not R, but in fact actually a bit of Stan code. </span>
<span id="cb48-216"><a href="#cb48-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-217"><a href="#cb48-217" aria-hidden="true" tabindex="-1"></a>When I work, I almost always use this pair of steps:</span>
<span id="cb48-218"><a href="#cb48-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-219"><a href="#cb48-219" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb48-220"><a href="#cb48-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-221"><a href="#cb48-221" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(bird_formula, <span class="at">data =</span> bird_data)</span>
<span id="cb48-222"><a href="#cb48-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-223"><a href="#cb48-223" aria-hidden="true" tabindex="-1"></a>bird_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">60</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">ub =</span> <span class="dv">60</span>))</span>
<span id="cb48-224"><a href="#cb48-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-225"><a href="#cb48-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-226"><a href="#cb48-226" aria-hidden="true" tabindex="-1"></a>The first step uses the formula and the dataset to print out a table of all the parameters in the model, and their default priors. I use this table as a reference during the second step, where I define my own priors for my model. </span>
<span id="cb48-227"><a href="#cb48-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-228"><a href="#cb48-228" aria-hidden="true" tabindex="-1"></a>Always do these two steps!  </span>
<span id="cb48-229"><a href="#cb48-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-230"><a href="#cb48-230" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb48-231"><a href="#cb48-231" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why does `get_prior` require the dataset?</span></span>
<span id="cb48-232"><a href="#cb48-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-233"><a href="#cb48-233" aria-hidden="true" tabindex="-1"></a>In Bayesian statistics, quantites are either unobserved or observed. Anything observed is called "data", and anything unobserved is called a "parameter". The design of  <span class="in">`brms`</span> tries to be very general and flexible; it looks for the names of objects from the formula in the dataset to see if they are observed quantities or parameters.</span>
<span id="cb48-234"><a href="#cb48-234" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-235"><a href="#cb48-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-236"><a href="#cb48-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-237"><a href="#cb48-237" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sampling a prior in `brms`</span></span>
<span id="cb48-238"><a href="#cb48-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-239"><a href="#cb48-239" aria-hidden="true" tabindex="-1"></a>When we run <span class="in">`brm(bird_formula, data = bird_data, prior = bird_prior, sample_prior = "only")`</span>, we sample only from the prior. </span>
<span id="cb48-240"><a href="#cb48-240" aria-hidden="true" tabindex="-1"></a>This generates a large number of simulated datasets -- the default is 4000!</span>
<span id="cb48-241"><a href="#cb48-241" aria-hidden="true" tabindex="-1"></a>Each time the model samples, it draws a new value for the unobserved average (<span class="in">`avg_birds_per_person`</span>) and then 22 values for the number of birds seen by each person. </span>
<span id="cb48-242"><a href="#cb48-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-243"><a href="#cb48-243" aria-hidden="true" tabindex="-1"></a>Let's pull out just a few of these datasets and visualize them.</span>
<span id="cb48-244"><a href="#cb48-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-245"><a href="#cb48-245" aria-hidden="true" tabindex="-1"></a>We'll use a wonderful package called <span class="co">[</span><span class="ot">`tidybayes`</span><span class="co">](http://mjskay.github.io/tidybayes/)</span> to easily extract posterior draws from <span class="in">`stanfit`</span> objects. </span>
<span id="cb48-246"><a href="#cb48-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-247"><a href="#cb48-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-250"><a href="#cb48-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-251"><a href="#cb48-251" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb48-252"><a href="#cb48-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-253"><a href="#cb48-253" aria-hidden="true" tabindex="-1"></a>tidybayes<span class="sc">::</span><span class="fu">get_variables</span>(bird_model)</span>
<span id="cb48-254"><a href="#cb48-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-255"><a href="#cb48-255" aria-hidden="true" tabindex="-1"></a>birds_intercepts <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(bird_model, Intercept,</span>
<span id="cb48-256"><a href="#cb48-256" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># ndraws = 20,</span></span>
<span id="cb48-257"><a href="#cb48-257" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">seed =</span> <span class="dv">525600</span>)</span>
<span id="cb48-258"><a href="#cb48-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-259"><a href="#cb48-259" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(birds_intercepts)</span>
<span id="cb48-260"><a href="#cb48-260" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(birds_intercepts)</span>
<span id="cb48-261"><a href="#cb48-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-262"><a href="#cb48-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-265"><a href="#cb48-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-266"><a href="#cb48-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Prior simulations of bird observations</span></span>
<span id="cb48-267"><a href="#cb48-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb48-268"><a href="#cb48-268" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">add_predicted_draws</span>(</span>
<span id="cb48-269"><a href="#cb48-269" aria-hidden="true" tabindex="-1"></a>  bird_data, </span>
<span id="cb48-270"><a href="#cb48-270" aria-hidden="true" tabindex="-1"></a>  bird_model)</span>
<span id="cb48-271"><a href="#cb48-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-272"><a href="#cb48-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-273"><a href="#cb48-273" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb48-274"><a href="#cb48-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-275"><a href="#cb48-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.draw <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">|&gt;</span>   </span>
<span id="cb48-276"><a href="#cb48-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction)) <span class="sc">+</span> </span>
<span id="cb48-277"><a href="#cb48-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dotplot</span>() <span class="sc">+</span> </span>
<span id="cb48-278"><a href="#cb48-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.draw)</span>
<span id="cb48-279"><a href="#cb48-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-280"><a href="#cb48-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-281"><a href="#cb48-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-282"><a href="#cb48-282" aria-hidden="true" tabindex="-1"></a>Here we pass <span class="in">`tidybayes::spread_draws()`</span> the model name, as well as the names of the parameters that we want to work with. The handy function <span class="in">`tidyverse::get_variables`</span> is a key part of this workflow. </span>
<span id="cb48-283"><a href="#cb48-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-284"><a href="#cb48-284" aria-hidden="true" tabindex="-1"></a>Let's see what we get from tidybayes by looking at the first few rows.</span>
<span id="cb48-285"><a href="#cb48-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-288"><a href="#cb48-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-289"><a href="#cb48-289" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb48-290"><a href="#cb48-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-291"><a href="#cb48-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">9</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-292"><a href="#cb48-292" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb48-293"><a href="#cb48-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-294"><a href="#cb48-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-295"><a href="#cb48-295" aria-hidden="true" tabindex="-1"></a>Remember we asked for only 25 of the 4000 posterior samples. Here is one sample, and just a bit of the next. </span>
<span id="cb48-296"><a href="#cb48-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-297"><a href="#cb48-297" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We can see that the value of `avg_birds_per_person` is the same within each iteration. The model uses this average to sample every `bird_count` value, one for each person making observations. Then the program takes a new value of `avg_birds_per_person` and simulates everyone's `bird_count` again! --&gt;</span></span>
<span id="cb48-298"><a href="#cb48-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-299"><a href="#cb48-299" aria-hidden="true" tabindex="-1"></a>Let's take a look at some of these simulations:</span>
<span id="cb48-300"><a href="#cb48-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-303"><a href="#cb48-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-304"><a href="#cb48-304" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Prior simulations of bird counts. Green bars are the mean for a particular simulation, and orange histograms show the distribution of observations around this mean.</span></span>
<span id="cb48-305"><a href="#cb48-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-306"><a href="#cb48-306" aria-hidden="true" tabindex="-1"></a>bird_counts_simulated <span class="sc">|&gt;</span> </span>
<span id="cb48-307"><a href="#cb48-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-308"><a href="#cb48-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.draw <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">16</span>))  <span class="sc">|&gt;</span> </span>
<span id="cb48-309"><a href="#cb48-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(birds_intercepts, <span class="at">by =</span> <span class="fu">join_by</span>(.draw)) <span class="sc">|&gt;</span> </span>
<span id="cb48-310"><a href="#cb48-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .prediction)) <span class="sc">+</span> </span>
<span id="cb48-311"><a href="#cb48-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb48-312"><a href="#cb48-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> Intercept),</span>
<span id="cb48-313"><a href="#cb48-313" aria-hidden="true" tabindex="-1"></a>             <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb48-314"><a href="#cb48-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.draw) <span class="sc">+</span> </span>
<span id="cb48-315"><a href="#cb48-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb48-316"><a href="#cb48-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-317"><a href="#cb48-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-318"><a href="#cb48-318" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter recovery</span></span>
<span id="cb48-319"><a href="#cb48-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-320"><a href="#cb48-320" aria-hidden="true" tabindex="-1"></a>Let's go back and look at the fake datasets we created in R </span>
<span id="cb48-321"><a href="#cb48-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-324"><a href="#cb48-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-325"><a href="#cb48-325" aria-hidden="true" tabindex="-1"></a>avg_birds_per_person</span>
<span id="cb48-326"><a href="#cb48-326" aria-hidden="true" tabindex="-1"></a>bird_count</span>
<span id="cb48-327"><a href="#cb48-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-328"><a href="#cb48-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-329"><a href="#cb48-329" aria-hidden="true" tabindex="-1"></a>and let's see if we can recapture the only known parameter, <span class="in">`avg_birds_per_person`</span>, which is equal to <span class="in">`r avg_birds_per_person`</span>.</span>
<span id="cb48-330"><a href="#cb48-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-331"><a href="#cb48-331" aria-hidden="true" tabindex="-1"></a>We'll do it first in R, using the function <span class="in">`fitdistr`</span> from the <span class="in">`MASS`</span> package:</span>
<span id="cb48-332"><a href="#cb48-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-335"><a href="#cb48-335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-336"><a href="#cb48-336" aria-hidden="true" tabindex="-1"></a>MASS<span class="sc">::</span><span class="fu">fitdistr</span>(bird_count, dpois, <span class="at">start =</span> <span class="fu">list</span>(<span class="at">lambda=</span><span class="dv">10</span>))</span>
<span id="cb48-337"><a href="#cb48-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-338"><a href="#cb48-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-339"><a href="#cb48-339" aria-hidden="true" tabindex="-1"></a>This could also be done with <span class="in">`glm`</span></span>
<span id="cb48-340"><a href="#cb48-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-343"><a href="#cb48-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-344"><a href="#cb48-344" aria-hidden="true" tabindex="-1"></a>bird_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(bird_count <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">"poisson"</span>)</span>
<span id="cb48-345"><a href="#cb48-345" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(bird_glm))</span>
<span id="cb48-346"><a href="#cb48-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-347"><a href="#cb48-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-348"><a href="#cb48-348" aria-hidden="true" tabindex="-1"></a>You can see that in all cases we are getting close to the value of <span class="in">`avg_birds_per_person`</span>, which in these simulations is the true value.</span>
<span id="cb48-349"><a href="#cb48-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-350"><a href="#cb48-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-351"><a href="#cb48-351" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter recovery in brms -- sampling the posterior</span></span>
<span id="cb48-352"><a href="#cb48-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-353"><a href="#cb48-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-354"><a href="#cb48-354" aria-hidden="true" tabindex="-1"></a>Time for the <span class="co">[</span><span class="ot">HMC Slides!</span><span class="co">](slides/03_Stan)</span></span>
<span id="cb48-355"><a href="#cb48-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-356"><a href="#cb48-356" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb48-357"><a href="#cb48-357" aria-hidden="true" tabindex="-1"></a><span class="fu">### EXERCISE: parameter recovery in Stan</span></span>
<span id="cb48-358"><a href="#cb48-358" aria-hidden="true" tabindex="-1"></a>Use the Stan code above to fit the model to our simulated data. Do we recover the parameters?</span>
<span id="cb48-359"><a href="#cb48-359" aria-hidden="true" tabindex="-1"></a>That is, rerun the example above but change the <span class="in">`sample_prior`</span> argument to "yes"</span>
<span id="cb48-360"><a href="#cb48-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-361"><a href="#cb48-361" aria-hidden="true" tabindex="-1"></a>Select one of our simulations to be the dataset for this analysis</span>
<span id="cb48-362"><a href="#cb48-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-365"><a href="#cb48-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-366"><a href="#cb48-366" aria-hidden="true" tabindex="-1"></a>one_bird_simulation <span class="ot">&lt;-</span> bird_simulations <span class="sc">|&gt;</span> </span>
<span id="cb48-367"><a href="#cb48-367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select one simulation, could be any one</span></span>
<span id="cb48-368"><a href="#cb48-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(simulation_id <span class="sc">==</span> <span class="dv">10</span>)</span>
<span id="cb48-369"><a href="#cb48-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-370"><a href="#cb48-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-371"><a href="#cb48-371" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-372"><a href="#cb48-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-373"><a href="#cb48-373" aria-hidden="true" tabindex="-1"></a>:::{.callout-note collapse="true"}</span>
<span id="cb48-374"><a href="#cb48-374" aria-hidden="true" tabindex="-1"></a><span class="fu">### SOLUTION</span></span>
<span id="cb48-375"><a href="#cb48-375" aria-hidden="true" tabindex="-1"></a>the <span class="in">`brms`</span> syntax is only slightly changed! note the different filename and the different object name as well:</span>
<span id="cb48-376"><a href="#cb48-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-379"><a href="#cb48-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-380"><a href="#cb48-380" aria-hidden="true" tabindex="-1"></a>bird_posterior <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> bird_formula,</span>
<span id="cb48-381"><a href="#cb48-381" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> one_bird_simulation,</span>
<span id="cb48-382"><a href="#cb48-382" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior =</span> bird_prior, </span>
<span id="cb48-383"><a href="#cb48-383" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sample_prior =</span> <span class="st">"yes"</span>,</span>
<span id="cb48-384"><a href="#cb48-384" aria-hidden="true" tabindex="-1"></a>                      <span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"topics/01_simulation/bird_posterior.rds"</span>),</span>
<span id="cb48-385"><a href="#cb48-385" aria-hidden="true" tabindex="-1"></a>                      <span class="at">file_refit =</span> <span class="st">"on_change"</span>, <span class="at">refresh =</span><span class="dv">0</span>)</span>
<span id="cb48-386"><a href="#cb48-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-387"><a href="#cb48-387" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bird_posterior)</span>
<span id="cb48-388"><a href="#cb48-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-389"><a href="#cb48-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-390"><a href="#cb48-390" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-391"><a href="#cb48-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-392"><a href="#cb48-392" aria-hidden="true" tabindex="-1"></a>We can look at a table of coefficients but it is much easier to once again look at posterior samples as a figure.</span>
<span id="cb48-393"><a href="#cb48-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-394"><a href="#cb48-394" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb48-395"><a href="#cb48-395" aria-hidden="true" tabindex="-1"></a><span class="fu"># Visualize everything! </span></span>
<span id="cb48-396"><a href="#cb48-396" aria-hidden="true" tabindex="-1"></a>Bayesian workflows are highly visual. Make as many plots as you can: of your parameters, your predictions, the performance of your chains, etc.</span>
<span id="cb48-397"><a href="#cb48-397" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-398"><a href="#cb48-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-399"><a href="#cb48-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### bayesplot</span></span>
<span id="cb48-400"><a href="#cb48-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-401"><a href="#cb48-401" aria-hidden="true" tabindex="-1"></a>Another essential package for working with posterior samples is called <span class="co">[</span><span class="ot">`bayesplot`</span><span class="co">](http://mc-stan.org/bayesplot/)</span>. Let's use it to compare the posterior and prior distribution for the intercept.</span>
<span id="cb48-402"><a href="#cb48-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-405"><a href="#cb48-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-406"><a href="#cb48-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: posterior distribution for `avg_birds_per_person`. The orange line is the true parameter value, which we simulated in R.</span></span>
<span id="cb48-407"><a href="#cb48-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-408"><a href="#cb48-408" aria-hidden="true" tabindex="-1"></a>tidybayes<span class="sc">::</span><span class="fu">get_variables</span>(bird_posterior)</span>
<span id="cb48-409"><a href="#cb48-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-410"><a href="#cb48-410" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_areas</span>(bird_posterior, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"prior_Intercept"</span>)) <span class="sc">+</span> </span>
<span id="cb48-411"><a href="#cb48-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">unique</span>(one_bird_simulation<span class="sc">$</span>lambda), <span class="at">col =</span> <span class="st">"orange"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb48-412"><a href="#cb48-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-413"><a href="#cb48-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-414"><a href="#cb48-414" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Posterior predictive checks</span></span>
<span id="cb48-415"><a href="#cb48-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-416"><a href="#cb48-416" aria-hidden="true" tabindex="-1"></a>Bayesian models MAKE data, which suggests a clear way to validate our models: ask the model to make some data, then see how well these data correspond to biology (e.g. to our real data).  Here, we will take 50 fake datasets of bird counts and compare them to the simulation we first did in R.</span>
<span id="cb48-417"><a href="#cb48-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-418"><a href="#cb48-418" aria-hidden="true" tabindex="-1"></a>The process involves a bit of fiddling around in R to get the simulated data, but then <span class="in">`bayesplot`</span> does all the work: </span>
<span id="cb48-419"><a href="#cb48-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-422"><a href="#cb48-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-423"><a href="#cb48-423" aria-hidden="true" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(bird_posterior, <span class="at">type =</span> <span class="st">"dens_overlay"</span>)</span>
<span id="cb48-424"><a href="#cb48-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-425"><a href="#cb48-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-426"><a href="#cb48-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-427"><a href="#cb48-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-428"><a href="#cb48-428" aria-hidden="true" tabindex="-1"></a><span class="fu">### Shinystan</span></span>
<span id="cb48-429"><a href="#cb48-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-430"><a href="#cb48-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb48-431"><a href="#cb48-431" aria-hidden="true" tabindex="-1"></a>shinystan<span class="sc">::</span><span class="fu">launch_shinystan</span>(bird_posterior)</span>
<span id="cb48-432"><a href="#cb48-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-433"><a href="#cb48-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-434"><a href="#cb48-434" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb48-435"><a href="#cb48-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-436"><a href="#cb48-436" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 1</span></span>
<span id="cb48-437"><a href="#cb48-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-438"><a href="#cb48-438" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>What would you do next to add complexity the bird-counting model above?</span>
<span id="cb48-439"><a href="#cb48-439" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>We plotted histograms to evaluate our model. Experiment with other types of plots. For example, what is the maximum value in each posterior simulation? What is the minimum? How to these compare to the real data? TIP: check out `<span class="in">` ?bayesplot::`</span>PPC-overview` ``</span>
<span id="cb48-440"><a href="#cb48-440" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb48-441"><a href="#cb48-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-442"><a href="#cb48-442" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 2</span></span>
<span id="cb48-443"><a href="#cb48-443" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Try to fit YOUR data and your chosen distribution from <span class="co">[</span><span class="ot">Monday's exercise</span><span class="co">](topics/00_distributions)</span>. Check to see if the distribution you chose is implemented in Stan -- see, for example, <span class="co">[</span><span class="ot">this list</span><span class="co">](https://mc-stan.org/docs/functions-reference/binary_distributions.html)</span>. </span>
<span id="cb48-444"><a href="#cb48-444" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Check your model using the plots we have already seen today.</span>
<span id="cb48-445"><a href="#cb48-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-446"><a href="#cb48-446" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Level 3</span></span>
<span id="cb48-447"><a href="#cb48-447" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>You would never actually do the analysis in this exercise! If all you want is the average of a Poisson distribution, you can get that without any sampling at all. Start by writing the model with a different prior:</span>
<span id="cb48-448"><a href="#cb48-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-449"><a href="#cb48-449" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-450"><a href="#cb48-450" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb48-451"><a href="#cb48-451" aria-hidden="true" tabindex="-1"></a>\text{Number of Birds}_{\text{seen by person i}} &amp;\sim \text{Poisson}(\lambda) <span class="sc">\\</span></span>
<span id="cb48-452"><a href="#cb48-452" aria-hidden="true" tabindex="-1"></a>\lambda &amp;\sim \text{Gamma}(9, .5)</span>
<span id="cb48-453"><a href="#cb48-453" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb48-454"><a href="#cb48-454" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-455"><a href="#cb48-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-456"><a href="#cb48-456" aria-hidden="true" tabindex="-1"></a>This lets us calculate the posterior distribution directly. See the equation <span class="co">[</span><span class="ot">on Wikipedia</span><span class="co">](https://en.wikipedia.org/wiki/Poisson_distribution#Bayesian_inference)</span> and calculate the posterior for our bird data.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>